/**
 * AI çŸ¥è¯†åº“ Tab é¡µé¢
 * æä¾›åŸºäºŽ DeepSeek AI çš„æ™ºèƒ½å¯¹è¯å’Œæ–‡æ¡£åˆ†æžåŠŸèƒ½
 */

import { common } from '@kit.AbilityKit';
import { DeepSeekService, AICallParams, AICallResult } from '../common/utils/DeepSeekService';
import { ContentParser, ParseResult } from '../common/utils/ContentParser';
import { fileIo } from '@kit.CoreFileKit';
import { util } from '@kit.ArkTS';

interface ChatMessage {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp: number;
}

const API_KEY_FILE = '.deepseek_api_key';

@Component
export struct KnowledgeTab {
  @State chatMessages: ChatMessage[] = [];
  @State inputText: string = '';
  @State isProcessing: boolean = false;
  @State apiKey: string = '';
  @State showApiKeyInput: boolean = false;
  @State apiKeyInput: string = '';
  @State showFileSelector: boolean = false;
  @State availableFiles: string[] = [];
  @State showToastMsg: boolean = false;
  @State toastText: string = '';
  @State toastType: string = 'info';

  private context: common.UIAbilityContext | null = null;
  private filesDir: string = '';
  private contentParser: ContentParser | null = null;
  private scroller: Scroller = new Scroller();

  aboutToAppear(): void {
    const ctx = this.getUIContext().getHostContext() as Context;
    this.context = ctx as common.UIAbilityContext;
    this.filesDir = this.context.filesDir;
    this.contentParser = ContentParser.getInstance(ctx);
    this.loadApiKey();
    this.addAssistantMessage('ä½ å¥½ï¼æˆ‘æ˜¯ AI åŠ©æ‰‹ï¼Œå¯ä»¥å¸®ä½ åˆ†æžæ–‡æ¡£ã€å›žç­”é—®é¢˜ã€‚\n\nç‚¹å‡»å³ä¸Šè§’è®¾ç½® API Key å¼€å§‹ä½¿ç”¨ã€‚');
  }

  private loadApiKey(): void {
    try {
      const keyPath = `${this.filesDir}/${API_KEY_FILE}`;
      if (fileIo.accessSync(keyPath)) {
        const file = fileIo.openSync(keyPath, fileIo.OpenMode.READ_ONLY);
        const stat = fileIo.statSync(keyPath);
        const buffer = new ArrayBuffer(stat.size);
        fileIo.readSync(file.fd, buffer);
        fileIo.closeSync(file);
        const decoder = new util.TextDecoder('utf-8');
        this.apiKey = decoder.decodeWithStream(new Uint8Array(buffer), { stream: false }).trim();
      }
    } catch (error) {
      console.warn('[KnowledgeTab] åŠ è½½ API Key å¤±è´¥');
    }
  }

  private saveApiKey(key: string): void {
    try {
      const keyPath = `${this.filesDir}/${API_KEY_FILE}`;
      const file = fileIo.openSync(keyPath, fileIo.OpenMode.READ_WRITE | fileIo.OpenMode.CREATE | fileIo.OpenMode.TRUNC);
      const encoder = new util.TextEncoder();
      const data = encoder.encodeInto(key);
      fileIo.writeSync(file.fd, data.buffer);
      fileIo.closeSync(file);
      this.apiKey = key;
      this.showApiKeyInput = false;
      this.showToast('API Key å·²ä¿å­˜', 'success');
    } catch (error) {
      this.showToast('ä¿å­˜å¤±è´¥', 'error');
    }
  }

  private addUserMessage(content: string): void {
    this.chatMessages.push({
      id: `user_${Date.now()}`,
      role: 'user',
      content: content,
      timestamp: Date.now()
    });
    this.chatMessages = this.chatMessages.slice();
    setTimeout((): void => { this.scroller.scrollEdge(Edge.Bottom); }, 100);
  }

  private addAssistantMessage(content: string): void {
    this.chatMessages.push({
      id: `assistant_${Date.now()}`,
      role: 'assistant',
      content: content,
      timestamp: Date.now()
    });
    this.chatMessages = this.chatMessages.slice();
    setTimeout((): void => { this.scroller.scrollEdge(Edge.Bottom); }, 100);
  }

  private async sendMessage(): Promise<void> {
    if (this.inputText.trim().length === 0) return;

    if (!this.apiKey || this.apiKey.trim().length === 0) {
      this.showToast('è¯·å…ˆè®¾ç½® API Key', 'error');
      this.showApiKeyInput = true;
      return;
    }

    const userInput = this.inputText.trim();
    this.inputText = '';
    this.addUserMessage(userInput);
    this.isProcessing = true;

    try {
      const params: AICallParams = {
        prompt: userInput,
        apiKey: this.apiKey,
        systemPrompt: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡æ¡£åˆ†æžåŠ©æ‰‹ï¼Œèƒ½å¤Ÿå¸®åŠ©ç”¨æˆ·ç†è§£å’Œåˆ†æžå„ç±»æ–‡æ¡£ã€‚å›žç­”è¦ç®€æ´æœ‰æ¡ç†ã€‚',
        temperature: 0.7,
        maxTokens: 2000
      };

      const result: AICallResult = await DeepSeekService.callAI(params);

      if (result.success) {
        this.addAssistantMessage(result.content);
      } else {
        this.addAssistantMessage(`è¯·æ±‚å¤±è´¥ï¼š${result.error || 'æœªçŸ¥é”™è¯¯'}`);
      }
    } catch (error) {
      this.addAssistantMessage(`å‘ç”Ÿé”™è¯¯ï¼š${error}`);
    } finally {
      this.isProcessing = false;
    }
  }

  private loadFileList(): void {
    try {
      let files = fileIo.listFileSync(this.filesDir);
      this.availableFiles = files.filter((f: string) => {
        return !f.startsWith('.') && (f.endsWith('.txt') || f.endsWith('.docx') || f.endsWith('.pdf'));
      });
    } catch (error) {
      this.showToast('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥', 'error');
    }
  }

  private async analyzeFile(filename: string): Promise<void> {
    if (!this.contentParser || !this.apiKey) {
      this.showToast('è¯·å…ˆè®¾ç½® API Key', 'error');
      return;
    }

    this.showFileSelector = false;
    this.addUserMessage(`åˆ†æžæ–‡ä»¶ï¼š${filename}`);
    this.isProcessing = true;

    try {
      const parseResult: ParseResult = await this.contentParser.parseDocument(filename);

      if (!parseResult.success) {
        this.addAssistantMessage(`æ— æ³•è¯»å–æ–‡ä»¶ï¼š${parseResult.error}`);
        this.isProcessing = false;
        return;
      }

      const prompt = `è¯·åˆ†æžä»¥ä¸‹æ–‡æ¡£ï¼Œæä¾›æ‘˜è¦å’Œå…³é”®è¦ç‚¹ï¼š

æ–‡æ¡£ï¼š${filename}ï¼ˆ${parseResult.wordCount}å­—ï¼‰

å†…å®¹ï¼š
${parseResult.content.substring(0, 4000)}

è¯·æä¾›ï¼š
1. æ‘˜è¦ï¼ˆ100-150å­—ï¼‰
2. 3-5ä¸ªå…³é”®è¦ç‚¹
3. æ–‡æ¡£ç±»åž‹åˆ¤æ–­`;

      const params: AICallParams = {
        prompt: prompt,
        apiKey: this.apiKey,
        systemPrompt: 'ä½ æ˜¯ä¸“ä¸šçš„æ–‡æ¡£åˆ†æžåŠ©æ‰‹ï¼Œæ“…é•¿æå–å…³é”®ä¿¡æ¯ã€‚å›žç­”è¦ç®€æ´æœ‰æ¡ç†ã€‚',
        temperature: 0.3,
        maxTokens: 1500
      };

      const result: AICallResult = await DeepSeekService.callAI(params);
      this.addAssistantMessage(result.success ? result.content : `åˆ†æžå¤±è´¥ï¼š${result.error}`);
    } catch (error) {
      this.addAssistantMessage(`åˆ†æžå‡ºé”™ï¼š${error}`);
    } finally {
      this.isProcessing = false;
    }
  }

  private showToast(message: string, type: string = 'info'): void {
    this.toastText = message;
    this.toastType = type;
    this.showToastMsg = true;
    setTimeout(() => { this.showToastMsg = false; }, 2500);
  }

  private formatTime(timestamp: number): string {
    const date = new Date(timestamp);
    return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ 
      Row() {
        Column() {
          Text('AI åŠ©æ‰‹')
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
          Text(this.apiKey ? 'å·²è¿žæŽ¥' : 'æœªè®¾ç½® API')
            .fontSize(11)
            .fontColor(this.apiKey ? '#34C759' : '#FF9500')
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        Button('è®¾ç½®')
          .fontSize(13)
          .height(34)
          .backgroundColor('#007AFF')
          .fontColor(Color.White)
          .borderRadius(8)
          .onClick(() => {
            this.apiKeyInput = this.apiKey;
            this.showApiKeyInput = true;
          })

        Button('æ¸…ç©º')
          .fontSize(13)
          .height(34)
          .backgroundColor('#FF3B30')
          .fontColor(Color.White)
          .borderRadius(8)
          .margin({ left: 8 })
          .onClick(() => {
            this.chatMessages = [];
            this.addAssistantMessage('å¯¹è¯å·²æ¸…ç©ºï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„ï¼Ÿ');
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      .backgroundColor(Color.White)

      // Toast æç¤º
      if (this.showToastMsg) {
        Text(this.toastText)
          .fontSize(13)
          .fontColor(Color.White)
          .backgroundColor(this.toastType === 'success' ? '#34C759' : (this.toastType === 'error' ? '#FF3B30' : '#007AFF'))
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .borderRadius(20)
          .margin({ top: 8 })
      }

      // å¯¹è¯åŒºåŸŸ
      Scroll(this.scroller) {
        Column() {
          ForEach(this.chatMessages, (msg: ChatMessage) => {
            Column() {
              Row() {
                if (msg.role === 'user') {
                  Blank().layoutWeight(1)
                }

                Column() {
                  Text(msg.content)
                    .fontSize(14)
                    .fontColor(msg.role === 'user' ? Color.White : '#333333')
                    .lineHeight(20)
                    .padding(12)
                    .backgroundColor(msg.role === 'user' ? '#007AFF' : Color.White)
                    .borderRadius(16)
                }
                .constraintSize({ maxWidth: '75%' })
                .alignItems(msg.role === 'user' ? HorizontalAlign.End : HorizontalAlign.Start)

                if (msg.role === 'assistant') {
                  Blank().layoutWeight(1)
                }
              }
              .width('100%')

              Text(this.formatTime(msg.timestamp))
                .fontSize(10)
                .fontColor('#AAAAAA')
                .margin({ top: 4 })
                .alignSelf(msg.role === 'user' ? ItemAlign.End : ItemAlign.Start)
            }
            .width('100%')
            .padding({ left: 16, right: 16, bottom: 12 })
          })
        }
        .width('100%')
        .padding({ top: 8 })
        .justifyContent(FlexAlign.Start)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .backgroundColor('#F0F0F0')
      .align(Alignment.Top)

      // åº•éƒ¨è¾“å…¥åŒº
      Column() {
        Row({ space: 8 }) {
          Button('ðŸ“„ åˆ†æžæ–‡ä»¶')
            .fontSize(12)
            .height(32)
            .backgroundColor('#34C759')
            .fontColor(Color.White)
            .borderRadius(16)
            .onClick(() => {
              this.loadFileList();
              this.showFileSelector = true;
            })
            .enabled(!this.isProcessing)
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 8 })

        Row({ space: 10 }) {
          TextInput({ placeholder: 'è¾“å…¥æ¶ˆæ¯...', text: this.inputText })
            .layoutWeight(1)
            .height(40)
            .backgroundColor(Color.White)
            .borderRadius(20)
            .padding({ left: 16, right: 16 })
            .onChange((value: string) => { this.inputText = value; })
            .onSubmit(() => { this.sendMessage(); })
            .enabled(!this.isProcessing)

          Button(this.isProcessing ? '...' : 'å‘é€')
            .width(56)
            .height(40)
            .fontSize(14)
            .backgroundColor(this.isProcessing ? '#C7C7CC' : '#007AFF')
            .fontColor(Color.White)
            .borderRadius(20)
            .onClick(() => { this.sendMessage(); })
            .enabled(!this.isProcessing && this.inputText.trim().length > 0)
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      }
      .backgroundColor('#F8F8F8')

      // API Key å¼¹çª—
      if (this.showApiKeyInput) {
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0,0,0,0.4)')
          .onClick(() => { this.showApiKeyInput = false; })
          .position({ x: 0, y: 0 })

        Column() {
          Text('è®¾ç½® API Key')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .margin({ bottom: 16 })

          TextInput({ placeholder: 'sk-...', text: this.apiKeyInput })
            .width('100%')
            .height(46)
            .backgroundColor('#F5F5F5')
            .borderRadius(10)
            .onChange((value: string) => { this.apiKeyInput = value; })
            .margin({ bottom: 12 })

          Text('ä»Ž DeepSeek å®˜ç½‘èŽ·å– API Key')
            .fontSize(11)
            .fontColor('#8E8E93')
            .margin({ bottom: 20 })

          Row({ space: 12 }) {
            Button('å–æ¶ˆ')
              .layoutWeight(1)
              .height(44)
              .backgroundColor('#E5E5E5')
              .fontColor('#333333')
              .borderRadius(10)
              .onClick(() => { this.showApiKeyInput = false; })

            Button('ä¿å­˜')
              .layoutWeight(1)
              .height(44)
              .backgroundColor('#007AFF')
              .fontColor(Color.White)
              .borderRadius(10)
              .onClick(() => {
                if (DeepSeekService.validateApiKey(this.apiKeyInput)) {
                  this.saveApiKey(this.apiKeyInput);
                } else {
                  this.showToast('API Key æ ¼å¼ä¸æ­£ç¡®', 'error');
                }
              })
          }
          .width('100%')
        }
        .width('85%')
        .padding(24)
        .backgroundColor(Color.White)
        .borderRadius(20)
        .position({ x: '7.5%', y: '25%' })
      }

      // æ–‡ä»¶é€‰æ‹©å¼¹çª—
      if (this.showFileSelector) {
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0,0,0,0.4)')
          .onClick(() => { this.showFileSelector = false; })
          .position({ x: 0, y: 0 })

        Column() {
          Text('é€‰æ‹©æ–‡ä»¶')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .margin({ bottom: 16 })

          if (this.availableFiles.length === 0) {
            Text('æš‚æ— å¯åˆ†æžçš„æ–‡ä»¶')
              .fontSize(14)
              .fontColor('#8E8E93')
              .padding(30)
          } else {
            Scroll() {
              Column({ space: 8 }) {
                ForEach(this.availableFiles, (filename: string) => {
                  Row() {
                    Text(filename.endsWith('.pdf') ? 'ðŸ“•' : (filename.endsWith('.docx') ? 'ðŸ“˜' : 'ðŸ“„'))
                      .fontSize(20)
                      .margin({ right: 10 })
                    Text(filename)
                      .fontSize(14)
                      .fontColor('#333333')
                      .layoutWeight(1)
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                  }
                  .width('100%')
                  .height(50)
                  .padding({ left: 14, right: 14 })
                  .backgroundColor('#F8F8F8')
                  .borderRadius(10)
                  .onClick(() => { this.analyzeFile(filename); })
                })
              }
              .width('100%')
            }
            .height(200)
          }

          Button('å…³é—­')
            .width('100%')
            .height(44)
            .backgroundColor('#007AFF')
            .fontColor(Color.White)
            .borderRadius(10)
            .margin({ top: 16 })
            .onClick(() => { this.showFileSelector = false; })
        }
        .width('85%')
        .padding(24)
        .backgroundColor(Color.White)
        .borderRadius(20)
        .position({ x: '7.5%', y: '20%' })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}
