/*
 * Copyright (c) 2025 Huawei Device Co., Ltd.
 * Licensed under the Apache License,Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


// import { photoAccessHelper } from '@kit.MediaLibraryKit';
// import { fileIo } from '@kit.CoreFileKit';
// import Logger from '../common/utils/Logger';
// import { readUserFile, saveToUser } from '../common/utils/SavingAndSelectUserFile';
// import { photoPickerGetUri } from '../common/utils/PictureSaving';
//
// @Component
// export struct publicFilesTab {
//   @State picture: string = '';
//   @State flag: Boolean = false;
//   @State message: string = '';
//   @State content: string = '';
//   @State isInput: Boolean = false;
//   // Setting the button properties of a security control
//   @State saveButtonOptions: SaveButtonOptions = {
//     icon: SaveIconStyle.FULL_FILLED,
//     text: SaveDescription.SAVE_IMAGE,
//     buttonType: ButtonType.Capsule
//   }
//
//   build() {
//     Column() {
//       Column() {
//         Image($r('app.media.img'))
//           .borderRadius($r('app.float.default_24'))
//           .width($r('app.float.default_312'))
//           .height($r('app.float.default_147'))
//         // Create Security Control Button
//         SaveButton(this.saveButtonOptions)
//           .onClick(async (event, result: SaveButtonOnClickResult) => {
//             if (result == SaveButtonOnClickResult.SUCCESS) {
//               try {
//                 Logger.info('createAsset successfully, event: ' + event);
//                 let context = this.getUIContext().getHostContext();
//                 let phAccessHelper = photoAccessHelper.getPhotoAccessHelper(context);
//                 // Creating a Media File
//                 let uri = await phAccessHelper.createAsset(photoAccessHelper.PhotoType.IMAGE, 'jpg')
//                   .catch((error: BusinessError<Error>) => {
//                     Logger.error(`createAsset catch error, code: ${error.code}, message: ${error.message}`);
//                     return '';
//                   })
//                 Logger.info('createAsset successfully, uri: ' + uri);
//                 // Open the created media file and read the local file and convert it to ArrayBuffer for easy filling.
//                 let file = await fileIo.open(uri, fileIo.OpenMode.READ_WRITE);
//                 let buffer = context!.resourceManager.getMediaContentSync($r('app.media.img').id);
//                 // Write the read ArrayBuffer to the new media file.
//                 let writeLen = await fileIo.write(file.fd, buffer.buffer);
//                 Logger.info('write success,len=' + writeLen);
//                 await fileIo.close(file);
//               } catch (err) {
//                 Logger.error('createAsset failed, message = ', err);
//               }
//             } else {
//               Logger.error('SaveButtonOnClickResult createAsset failed');
//             }
//           })
//       }
//       .margin({ bottom: $r('app.float.default_10') })
//       .width($r('app.float.default_336'))
//       .height($r('app.float.default_223'))
//       .borderRadius($r('app.float.default_24'))
//       .justifyContent(FlexAlign.SpaceAround)
//       .backgroundColor($r('app.color.start_window_background'))
//
//       Column() {
//         Text($r('app.string.select_photo'))
//           .width($r('app.float.default_302'))
//           .height($r('app.float.default_48'))
//           .lineHeight($r('app.float.default_22'))
//           .fontFamily('HarmonyHeiTi-Medium')
//           .fontSize($r('app.float.default_16'))
//           .fontWeight(500)
//           .textAlign(TextAlign.Start)
//           .fontColor($r('app.color.text_color'))
//         Column() {
//           if (!this.flag) {
//             Image($r('app.media.ic_folder_add2'))
//               .width($r('app.float.default_24'))
//               .height($r('app.float.default_24'))
//               .objectFit(ImageFit.Contain)
//           } else {
//             Image(this.picture)
//               .width('100%')
//               .height('100%')
//               .borderRadius($r('app.float.default_24'))
//           }
//         }
//         .width($r('app.float.default_312'))
//         .height($r('app.float.default_147'))
//         .borderRadius($r('app.float.default_16'))
//         .backgroundColor($r('app.color.picture_background'))
//         .onClick(async () => {
//           await photoPickerGetUri().then(value => {
//             this.flag = true;
//             this.picture = value;
//           });
//         })
//         .justifyContent(FlexAlign.Center)
//         .alignItems(HorizontalAlign.Center)
//       }
//       .margin({ bottom: $r('app.float.default_10') })
//       .backgroundColor($r('app.color.start_window_background'))
//       .width($r('app.float.default_336'))
//       .height($r('app.float.default_213'))
//       .borderRadius($r('app.float.default_24'))
//
//       Column() {
//         TextArea({ placeholder: $r('app.string.textarea_default2'), text: this.isInput ? this.content : this.message })
//           .onChange((value: string) => {
//             this.content = value;
//           })
//           .width($r('app.float.default_312'))
//           .height($r('app.float.default_120'))
//           .margin({ top: $r('app.float.default_10'), bottom: $r('app.float.default_10') })
//           .enableKeyboardOnFocus(false)
//         Button($r('app.string.button3'))
//           .width($r('app.float.default_312'))
//           .height($r('app.float.default_40'))
//           .onClick(() => {
//             saveToUser(this.content)
//             this.content = '';
//             this.isInput = true;
//           })
//           .margin({ bottom: $r('app.float.default_10') })
//         Button($r('app.string.button4'))
//           .width($r('app.float.default_312'))
//           .height($r('app.float.default_40'))
//           .onClick(async () => {
//             await readUserFile().then((value: string) => {
//               this.message = value;
//               this.isInput = false;
//             })
//           })
//       }
//       .backgroundColor($r('app.color.start_window_background'))
//       .width($r('app.float.default_336'))
//       .height('251')
//       .borderRadius($r('app.float.default_24'))
//       .margin({ bottom: $r('app.float.default_100') })
//     }
//     .width('100%')
//   }
// }

import { FileManager } from '../common/utils/FileManager';
import { fileIo } from '@kit.CoreFileKit';
import { photoPickerGetUri } from '../common/utils/PictureSaving';
import { FileInfo } from '../common/utils/FileManager';
import { readFile } from '../common/utils/ReadFile';
import { deleteFile, initDeleteUtils } from '../common/utils/DeleteFile';
import fs from '@ohos.file.fs';

@Component
export struct publicFilesTab {
  // Êñ∞Â¢ûÁä∂ÊÄÅÂèòÈáè
  @State fileList: Array<FileInfo> = []; // Êñá‰ª∂ÂàóË°®
  @State searchKeyword: string = ''; // ÊêúÁ¥¢ÂÖ≥ÈîÆÂ≠ó
  @State selectedFile: string = ''; // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÊñá‰ª∂
  @State fileContent: string = ''; // Êñá‰ª∂ÂÜÖÂÆπ
  @State showFileContent: boolean = false; // ÊòØÂê¶ÊòæÁ§∫Êñá‰ª∂ÂÜÖÂÆπ
  @State newFileName: string = ''; // Êñ∞Êñá‰ª∂Âêç
  @State fileManager: FileManager | null = null; // Êñá‰ª∂ÁÆ°ÁêÜÂô®ÂÆû‰æã

  // Âà†Èô§ÁöÑÁä∂ÊÄÅÂèòÈáè
  @State showSaveSuccess: boolean = false;
  @State saveMessage: string = '';

  // Êñá‰ª∂Êìç‰ΩúËèúÂçïÁõ∏ÂÖ≥Áä∂ÊÄÅ
  @State showFileActionMenu: boolean = false;
  @State selectedFileForMenu: string = '';

  // ÈáçÂëΩÂêçÁä∂ÊÄÅ
  @State renamingFile: string = '';
  @State newFilename: string = '';
  @State showRenameDialog: boolean = false;

  // Êñá‰ª∂Êìç‰ΩúÈù¢ÊùøÁä∂ÊÄÅ
  @State showFileActionPanel: boolean = false;
  @State selectedFileForPanel: string = '';

  aboutToAppear() {
    let context = this.getUIContext().getHostContext() as Context;
    this.fileManager = new FileManager(context);
    initDeleteUtils(context);
    // this.searchFilesWithInfo();
    this.loadFileListWithInfo();
  }

  onPageShow() {
    console.log('È°µÈù¢ÊòæÁ§∫ÔºåÂà∑Êñ∞Êñá‰ª∂ÂàóË°®');
    this.searchFilesWithInfo();
  }

  // Âä†ËΩΩÊñá‰ª∂ÂàóË°®ÔºàÂåÖÂê´ËØ¶ÁªÜ‰ø°ÊÅØÔºâ
  async loadFileListWithInfo() {
    console.log('Âä†ËΩΩÊñá‰ª∂ÂàóË°®ÔºàÂ∏¶ËØ¶ÁªÜ‰ø°ÊÅØÔºâ...');

    if (this.fileManager) {
      try {
        const files = await this.fileManager.getAllFilesWithInfo();
        console.log('Ëé∑ÂèñÂà∞ÁöÑÊñá‰ª∂Êï∞Èáè:', files.length);
        this.fileList = files;

        if (files.length > 0) {
          console.log('Á§∫‰æãÊñá‰ª∂‰ø°ÊÅØ:', {
            filename: files[0].filename,
            size: files[0].sizeReadable,
            ctime: files[0].ctimeFormatted
          });
        }
      } catch (error) {
        console.error('Âä†ËΩΩÊñá‰ª∂ÂàóË°®Â§±Ë¥•:', error);
        this.fileList = [];
      }
    }
  }

  // ÊêúÁ¥¢Êñá‰ª∂ÔºàÂ∏¶ËØ¶ÁªÜ‰ø°ÊÅØÔºâ
  async searchFilesWithInfo() {
    console.log('ÊêúÁ¥¢Êñá‰ª∂:', this.searchKeyword);

    if (this.fileManager) {
      if (this.searchKeyword.trim() === '') {
        await this.loadFileListWithInfo();
      } else {
        const files = await this.fileManager.searchFilesWithInfo(this.searchKeyword);
        this.fileList = files;
        console.log('ÊêúÁ¥¢ÁªìÊûú:', files.length, '‰∏™Êñá‰ª∂');
      }
    }
  }

  // ÊâßË°åÂà†Èô§Êñá‰ª∂ÁöÑÊñπÊ≥ï
  private async executeDeleteFile(filename: string) {
    console.log(`ÊâßË°åÂà†Èô§Êñá‰ª∂: ${filename}`);
    const success = deleteFile(filename);
    if (success) {
      console.log(`Êñá‰ª∂ ${filename} Âà†Èô§ÊàêÂäü`);
      await this.loadFileListWithInfo();

      if (this.selectedFile === filename) {
        this.selectedFile = '';
        this.fileContent = '';
        this.showFileContent = false;
      }

      this.saveMessage = `Êñá‰ª∂ "${filename}" Â∑≤Âà†Èô§`;
      this.showSaveSuccess = true;
      setTimeout(() => {
        this.showSaveSuccess = false;
      }, 3000);
    } else {
      console.log(`Êñá‰ª∂ ${filename} Âà†Èô§Â§±Ë¥•`);
      this.saveMessage = `Âà†Èô§Êñá‰ª∂Â§±Ë¥•`;
      this.showSaveSuccess = true;
      setTimeout(() => {
        this.showSaveSuccess = false;
      }, 3000);
    }
  }

  // ÊâìÂºÄÊñá‰ª∂Êìç‰ΩúÈù¢Êùø
  private openFileActionPanel(filename: string) {
    this.selectedFileForPanel = filename;
    this.showFileActionPanel = true;
  }

  // ÂÖ≥Èó≠Êñá‰ª∂Êìç‰ΩúÈù¢Êùø
  private closeFileActionPanel() {
    this.showFileActionPanel = false;
    this.selectedFileForPanel = '';
  }

  // Êü•ÁúãÊñá‰ª∂ÂÜÖÂÆπ
  private async viewFileContent(filename: string) {
    if (this.fileManager) {
      try {
        const content = readFile(filename);
        console.log(`Êñá‰ª∂ÂÜÖÂÆπ:${content}`);


        this.selectedFile = filename;
        this.fileContent = content;
        this.showFileContent = true;
      } catch (error) {
        console.error(`ËØªÂèñÊñá‰ª∂Â§±Ë¥•: ${error}`);
        this.saveMessage = `ËØªÂèñÊñá‰ª∂Â§±Ë¥•: ${error}`;
        this.showSaveSuccess = true;
        setTimeout(() => {
          this.showSaveSuccess = false;
        }, 3000);
      }
    }
  }

  // private async updateFileContent() {
  //   if (!this.fileManager || !this.selectedFile) {
  //     console.error('Êõ¥Êñ∞Êñá‰ª∂ÂÜÖÂÆπÂèÇÊï∞‰∏çÂÆåÊï¥');
  //     return;
  //   }
  //
  //   try {
  //     // Áõ¥Êé•Ë∞ÉÁî® FileManager ÁöÑ updateFile ÊñπÊ≥ï
  //     const success = await this.fileManager.updateFile(this.selectedFile, this.fileContent);
  //
  //     if (success) {
  //       console.log(`Êñá‰ª∂ÂÜÖÂÆπÊõ¥Êñ∞ÊàêÂäü: ${this.selectedFile}`);
  //
  //       // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
  //       this.saveMessage = 'Êñá‰ª∂ÂÜÖÂÆπÂ∑≤‰øùÂ≠ò';
  //       this.showSaveSuccess = true;
  //       setTimeout(() => {
  //         this.showSaveSuccess = false;
  //       }, 2000);
  //
  //       // ÂÖ≥Èó≠Êñá‰ª∂ÂÜÖÂÆπÁïåÈù¢
  //       setTimeout(() => {
  //         this.showFileContent = false;
  //       }, 1000);
  //
  //       // Âà∑Êñ∞Êñá‰ª∂ÂàóË°®ÔºàÂõ†‰∏∫Êñá‰ª∂Â§ßÂ∞èÂèØËÉΩÂ∑≤ÊîπÂèòÔºâ
  //       await this.loadFileListWithInfo();
  //     } else {
  //       console.error('Êõ¥Êñ∞Êñá‰ª∂ÂÜÖÂÆπÂ§±Ë¥•');
  //       this.saveMessage = '‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï';
  //       this.showSaveSuccess = true;
  //       setTimeout(() => {
  //         this.showSaveSuccess = false;
  //       }, 3000);
  //     }
  //   } catch (error) {
  //     console.error(`Êõ¥Êñ∞Êñá‰ª∂ÂÜÖÂÆπËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ: ${error}`);
  //     this.saveMessage = `‰øùÂ≠òÂ§±Ë¥•: ${error}`;
  //     this.showSaveSuccess = true;
  //     setTimeout(() => {
  //       this.showSaveSuccess = false;
  //     }, 3000);
  //   }
  // }
  private async updateFileContent() {
    if (!this.selectedFile || !this.fileContent) {
      console.error('Êõ¥Êñ∞Êñá‰ª∂ÂÜÖÂÆπÂèÇÊï∞‰∏çÂÆåÊï¥');
      return;
    }

    try {
      console.log(`ÂºÄÂßãÊõ¥Êñ∞Êñá‰ª∂ÂÜÖÂÆπ: ${this.selectedFile}`);

      // Ëé∑ÂèñÊñá‰ª∂Ë∑ØÂæÑ
      const context = this.getUIContext().getHostContext() as Context;
      const filesDir = context.filesDir;
      const filePath = filesDir + '/' + this.selectedFile;

      console.log(`Êõ¥Êñ∞Êñá‰ª∂Ë∑ØÂæÑ: ${filePath}`);

      // ÂàõÂª∫Êñá‰ª∂ÊµÅÂπ∂ÂÜôÂÖ•ÂÜÖÂÆπ
      let fileStream = fileIo.createStreamSync(filePath, "w+");

      fileStream.writeSync(this.fileContent);
      fileStream.close();

      console.log(`Êñá‰ª∂ÂÜÖÂÆπÊõ¥Êñ∞ÊàêÂäü: ${this.selectedFile}`);
      console.log(`ÂÜôÂÖ•ÁöÑÂÜÖÂÆπÈïøÂ∫¶: ${this.fileContent.length}`);

      // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
      this.saveMessage = 'Êñá‰ª∂ÂÜÖÂÆπÂ∑≤‰øùÂ≠ò';
      this.showSaveSuccess = true;

      // ÂÖ≥Èó≠Êñá‰ª∂ÂÜÖÂÆπÁïåÈù¢
      setTimeout(() => {
        this.showFileContent = false;
      }, 1000);

      // Âà∑Êñ∞Êñá‰ª∂ÂàóË°®ÔºàÂõ†‰∏∫Êñá‰ª∂Â§ßÂ∞èÂèØËÉΩÂ∑≤ÊîπÂèòÔºâ
      await this.loadFileListWithInfo();

      // 3ÁßíÂêéÈöêËóèÊàêÂäüÊèêÁ§∫
      setTimeout(() => {
        this.showSaveSuccess = false;
      }, 3000);

    } catch (error) {
      console.error(`Êõ¥Êñ∞Êñá‰ª∂ÂÜÖÂÆπÂ§±Ë¥•: ${error}`);
      this.saveMessage = `‰øùÂ≠òÂ§±Ë¥•: ${error.message || error}`;
      this.showSaveSuccess = true;
      setTimeout(() => {
        this.showSaveSuccess = false;
      }, 3000);
    }
  }


  // ÊâìÂºÄÈáçÂëΩÂêçÂØπËØùÊ°Ü
  private openRenameDialog(filename: string) {
    this.renamingFile = filename;
    this.newFilename = filename;
    this.showRenameDialog = true;
  }

  // ÂÖ≥Èó≠ÈáçÂëΩÂêçÂØπËØùÊ°Ü
  private closeRenameDialog() {
    this.showRenameDialog = false;
    this.renamingFile = '';
    this.newFilename = '';
  }

  // ÊâßË°åÈáçÂëΩÂêç
  private async executeRename() {
    if (!this.fileManager || !this.renamingFile || !this.newFilename) {
      console.error('ÈáçÂëΩÂêçÂèÇÊï∞‰∏çÂÆåÊï¥');
      return;
    }

    if (this.renamingFile === this.newFilename.trim()) {
      this.saveMessage = 'Êñá‰ª∂ÂêçÊú™ÊîπÂèò';
      this.showSaveSuccess = true;
      setTimeout(() => {
        this.showSaveSuccess = false;
      }, 2000);
      this.closeRenameDialog();
      return;
    }

    if (this.newFilename.trim() === '') {
      this.saveMessage = 'Êñ∞Êñá‰ª∂Âêç‰∏çËÉΩ‰∏∫Á©∫';
      this.showSaveSuccess = true;
      setTimeout(() => {
        this.showSaveSuccess = false;
      }, 2000);
      return;
    }

    try {
      console.log(`old name${this.renamingFile} new name${this.newFilename.trim()}`);
      const success = await this.fileManager.renameFile(this.renamingFile, this.newFilename.trim());

      if (success) {
        console.log(`ÈáçÂëΩÂêçÊàêÂäü: ${this.renamingFile} -> ${this.newFilename}`);
        await this.loadFileListWithInfo();

        if (this.selectedFile === this.renamingFile) {
          this.selectedFile = this.newFilename.trim();
        }

        this.saveMessage = `Êñá‰ª∂Â∑≤ÈáçÂëΩÂêç‰∏∫ "${this.newFilename.trim()}"`;
        this.showSaveSuccess = true;
        setTimeout(() => {
          this.showSaveSuccess = false;
        }, 3000);

        this.closeRenameDialog();
      } else {
        console.error('ÈáçÂëΩÂêçÂ§±Ë¥•');
        this.saveMessage = 'ÈáçÂëΩÂêçÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂ÂêçÊòØÂê¶ÂêàÊ≥ïÊàñÂ∑≤Â≠òÂú®';
        this.showSaveSuccess = true;
        setTimeout(() => {
          this.showSaveSuccess = false;
        }, 3000);
      }
    } catch (error) {
      console.error(`ÈáçÂëΩÂêçËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ: ${error}`);
      this.saveMessage = `ÈáçÂëΩÂêçÂ§±Ë¥•: ${error}`;
      this.showSaveSuccess = true;
      setTimeout(() => {
        this.showSaveSuccess = false;
      }, 3000);
    }
  }



  // Ê†πÊçÆÊñá‰ª∂Êâ©Â±ïÂêçËøîÂõûÂØπÂ∫îÁöÑÂõæÊ†á
  private getFileIcon(filename: string): string {
    if (filename.endsWith('.txt')) return 'üìù';
    if (filename.endsWith('.pdf')) return 'üìï';
    if (filename.endsWith('.jpg') || filename.endsWith('.png') || filename.endsWith('.gif')) return 'üñºÔ∏è';
    if (filename.endsWith('.mp4') || filename.endsWith('.avi')) return 'üé¨';
    if (filename.endsWith('.mp3') || filename.endsWith('.wav')) return 'üéµ';
    if (filename.endsWith('.zip') || filename.endsWith('.rar')) return 'üóúÔ∏è';
    return 'üìÑ';
  }

  build() {
    Column() {
      // === È°∂ÈÉ®ÊêúÁ¥¢Ê†è ===
      Row() {
        TextInput({ placeholder: 'ÊêúÁ¥¢Êñá‰ª∂...', text: this.searchKeyword })
          .onChange((value: string) => {
            this.searchKeyword = value;
            this.searchFilesWithInfo();
          })
          .layoutWeight(1)
          .height(40)
          .margin({ right: 10 })
          .padding({ left: 10, right: 10 })
          .backgroundColor(Color.White)
          .border({ width: 1, color: Color.Gray, radius: 8 })

        Button('Âà∑Êñ∞')
          .onClick(() => {
            this.searchFilesWithInfo();
          })
          .height(40)
          .backgroundColor('#007AFF')
          .fontColor(Color.White)
          .borderRadius(8)
      }
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })

      // === ÊàêÂäüÊèêÁ§∫Ê∂àÊÅØ ===
      if (this.showSaveSuccess) {
        Text(this.saveMessage)
          .fontSize(14)
          .fontColor('#FFFFFF')
          .backgroundColor('#34C759')
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .borderRadius(8)
          .margin({ bottom: 12 })
      }

      // === Êñá‰ª∂ÂàóË°® ===
      if (this.fileList.length === 0) {
        Column() {
          Text("üìÅ")
            .fontSize(48)
            .margin({ bottom: 10 })
          Text(this.searchKeyword ? 'Êú™ÊâæÂà∞Áõ∏ÂÖ≥Êñá‰ª∂' : 'ÊöÇÊó†Êñá‰ª∂')
            .fontColor(Color.Gray)
        }
        .height(200)
        .justifyContent(FlexAlign.Center)
        .width('100%')
      } else {
        List({ space: 8 }) {
          ForEach(this.fileList, (fileInfo: FileInfo) => {
            ListItem() {
              Row() {
                Text(this.getFileIcon(fileInfo.filename))
                  .fontSize(18)
                  .margin({ right: 10 })

                Column() {
                  Text(fileInfo.filename)
                    .fontSize(15)
                    .fontWeight(FontWeight.Medium)
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .width('100%')

                  Row() {
                    Text(fileInfo.sizeReadable)
                      .fontSize(11)
                      .fontColor(Color.Gray)
                      .margin({ right: 12 })

                    // Text(fileInfo.ctimeFormatted)
                    //   .fontSize(11)
                    //   .fontColor(Color.Gray)
                  }
                }
                .layoutWeight(1)

                Row() {
                  Button('Êü•Áúã')
                    .onClick(() => {
                      this.openFileActionPanel(fileInfo.filename);
                    })
                    .height(28)
                    .fontSize(11)
                    .margin({ right: 4 })
                    .borderRadius(14)
                    .backgroundColor('#007AFF')
                    .fontColor(Color.White)

                  Button('Âà†Èô§')
                    .onClick(() => {
                      this.executeDeleteFile(fileInfo.filename);
                    })
                    .height(28)
                    .fontSize(11)
                    .borderRadius(14)
                    .backgroundColor($r('app.color.delete_button'))
                    .fontColor(Color.White)
                }
              }
              .padding({ left: 12, right: 12, top: 10, bottom: 10 })
              .backgroundColor(Color.White)
              .borderRadius(8)
              .border({ width: 1, color: '#F0F0F0' })
            }
          })
        }
        .height('100%')
      }

      // === Êñá‰ª∂Êìç‰ΩúÈù¢ÊùøÔºàÂ±Ö‰∏≠ÂºπÂá∫Ôºâ===
      if (this.showFileActionPanel) {
        Stack()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.5)')
          .onClick(() => {
            this.closeFileActionPanel();
          })
          .position({ x: 0, y: 0 })

        Column() {
          Row() {
            Text('Êñá‰ª∂Êìç‰Ωú')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .layoutWeight(1)

            Button('√ó')
              .fontSize(24)
              .fontColor('#666666')
              .backgroundColor(Color.Transparent)
              .onClick(() => {
                this.closeFileActionPanel();
              })
          }
          .width('100%')
          .padding({ left: 20, right: 20, top: 15, bottom: 15 })
          .border({ width: { bottom: 1 }, color: '#E0E0E0' })

          Column({ space: 12 }) {
            Row() {
              Text('Êñá‰ª∂Âêç:')
                .fontSize(16)
                .fontColor('#666666')
                .width('30%')
              Text(this.selectedFileForPanel)
                .fontSize(16)
                .fontColor('#007AFF')
                .fontWeight(FontWeight.Bold)
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .width('70%')
            }
            .width('100%')
          }
          .width('100%')
          .padding(20)

          Column({ space: 15 }) {
            Button('ÈáçÂëΩÂêç')
              .fontSize(18)
              .width('90%')
              .height(50)
              .backgroundColor('#007AFF')
              .fontColor('#FFFFFF')
              .borderRadius(10)
              .onClick(() => {
                this.openRenameDialog(this.selectedFileForPanel);
                this.closeFileActionPanel();
              })

            Button('Êü•ÁúãÂπ∂‰øÆÊîπÂÜÖÂÆπ')
              .fontSize(18)
              .width('90%')
              .height(50)
              .backgroundColor('#34C759')
              .fontColor('#FFFFFF')
              .borderRadius(10)
              .onClick(() => {
                this.viewFileContent(this.selectedFileForPanel);
                this.closeFileActionPanel();
              })

            Button('ÂèñÊ∂à')
              .fontSize(18)
              .width('90%')
              .height(50)
              .backgroundColor('#8E8E93')
              .fontColor('#FFFFFF')
              .borderRadius(10)
              .onClick(() => {
                this.closeFileActionPanel();
              })
          }
          .width('100%')
          .padding({ left: 20, right: 20, bottom: 20 })
          .alignItems(HorizontalAlign.Center)
        }
        .width('85%')
        .backgroundColor('#FFFFFF')
        .borderRadius(20)
        .shadow({ radius: 20, color: '#000000', offsetX: 0, offsetY: 0 })
        .position({ x: '7.5%', y: '25%' })
        .hitTestBehavior(HitTestMode.None)
      }

      // === ÈáçÂëΩÂêçÂØπËØùÊ°Ü ===
      if (this.showRenameDialog) {
        Stack()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.5)')
          .onClick(() => {
            this.closeRenameDialog();
          })

        Column() {
          Row() {
            Text('ÈáçÂëΩÂêçÊñá‰ª∂')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .layoutWeight(1)

            Button('√ó')
              .fontSize(24)
              .fontColor('#666666')
              .backgroundColor(Color.Transparent)
              .onClick(() => {
                this.closeRenameDialog();
              })
          }
          .width('100%')
          .padding({ left: 20, right: 20, top: 15, bottom: 15 })
          .border({ width: { bottom: 1 }, color: '#E0E0E0' })

          Column({ space: 15 }) {
            Row() {
              Text('ÂéüÊñá‰ª∂Âêç:')
                .fontSize(16)
                .fontColor('#666666')
                .width('30%')
              Text(this.renamingFile)
                .fontSize(16)
                .fontColor('#333333')
                .fontWeight(FontWeight.Medium)
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .width('70%')
            }
            .width('100%')

            Row() {
              Text('Êñ∞Êñá‰ª∂Âêç:')
                .fontSize(16)
                .fontColor('#666666')
                .width('30%')
              TextInput({
                placeholder: 'ËæìÂÖ•Êñ∞Êñá‰ª∂Âêç',
                text: this.newFilename
              })
                .onChange((value: string) => {
                  this.newFilename = value;
                })
                .width('70%')
                .height(40)
                .padding(10)
                .border({ width: 1, color: Color.Gray, radius: 8 })
            }
            .width('100%')
          }
          .width('100%')
          .padding(20)

          Row({ space: 15 }) {
            Button('ÂèñÊ∂à')
              .fontSize(16)
              .width('45%')
              .height(45)
              .backgroundColor('#8E8E93')
              .fontColor('#FFFFFF')
              .borderRadius(10)
              .onClick(() => {
                this.closeRenameDialog();
              })

            Button('Á°ÆÂÆö')
              .fontSize(16)
              .width('45%')
              .height(45)
              .backgroundColor('#007AFF')
              .fontColor('#FFFFFF')
              .borderRadius(10)
              .onClick(() => {
                this.executeRename();
              })
          }
          .width('100%')
          .padding({ left: 20, right: 20, bottom: 20 })
        }
        .width('85%')
        .backgroundColor('#FFFFFF')
        .borderRadius(20)
        .shadow({ radius: 20, color: '#000000', offsetX: 0, offsetY: 0 })
        .position({ x: '7.5%', y: '30%' })
        .hitTestBehavior(HitTestMode.None)
      }

      // === Êñá‰ª∂ÂÜÖÂÆπÊü•Áúã/ÁºñËæëÁïåÈù¢ ===
      if (this.showFileContent && this.selectedFile) {
        Stack()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.5)')
          .onClick(() => {
            this.showFileContent = false;
          })

        Column() {
          Row() {
            Text('ÁºñËæëÊñá‰ª∂ÂÜÖÂÆπ')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .layoutWeight(1)

            Button('√ó')
              .fontSize(24)
              .fontColor('#666666')
              .backgroundColor(Color.Transparent)
              .onClick(() => {
                this.showFileContent = false;
              })
          }
          .width('100%')
          .padding({ left: 20, right: 20, top: 15, bottom: 15 })
          .border({ width: { bottom: 1 }, color: '#E0E0E0' })

          Column({ space: 15 }) {
            Row() {
              Text('Êñá‰ª∂Âêç:')
                .fontSize(16)
                .fontColor('#666666')
                .width('20%')
              Text(this.selectedFile)
                .fontSize(16)
                .fontColor('#007AFF')
                .fontWeight(FontWeight.Medium)
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .width('80%')
            }
            .width('100%')

            Text('Êñá‰ª∂ÂÜÖÂÆπ:')
              .fontSize(16)
              .fontColor('#666666')
              .width('100%')
              .textAlign(TextAlign.Start)

            TextArea({ text: this.fileContent })
              .onChange((value: string) => {
                this.fileContent = value;
              })
              .width('100%')
              .height(300)
              .backgroundColor('#F8F8F8')
              .padding(10)
              .border({ width: 1, color: '#E0E0E0', radius: 8 })
          }
          .width('100%')
          .padding(20)

          Row({ space: 15 }) {
            Button('ÂèñÊ∂à')
              .fontSize(16)
              .width('45%')
              .height(45)
              .backgroundColor('#8E8E93')
              .fontColor('#FFFFFF')
              .borderRadius(10)
              .onClick(() => {
                this.showFileContent = false;
              })

            Button('‰øùÂ≠ò‰øÆÊîπ')
              .fontSize(16)
              .width('45%')
              .height(45)
              .backgroundColor('#34C759')
              .fontColor('#FFFFFF')
              .borderRadius(10)
              .onClick(() => {
                this.updateFileContent();
              })
          }
          .width('100%')
          .padding({ left: 20, right: 20, bottom: 20 })
        }
        .width('85%')
        .backgroundColor('#FFFFFF')
        .borderRadius(20)
        .shadow({ radius: 20, color: '#000000', offsetX: 0, offsetY: 0 })
        .position({ x: '7.5%', y: '15%' })
        .hitTestBehavior(HitTestMode.None)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}
