/*
 * å›žæ”¶ç«™Tabé¡µé¢ - å®žçŽ°å·²åˆ é™¤æ–‡ä»¶çš„æŸ¥çœ‹å’Œæ¢å¤åŠŸèƒ½
 */

import { TrashManager, TrashFileInfo } from '../common/utils/TrashManager';

@Component
export struct TrashTab {
  @State trashFiles: TrashFileInfo[] = [];
  @State showMessage: boolean = false;
  @State messageText: string = '';
  @State messageType: string = 'success';
  @State showConfirmDialog: boolean = false;
  @State confirmAction: string = ''; // 'empty' | 'delete' | 'restore_all'
  @State selectedTrashName: string = '';
  @State isLoading: boolean = false;

  private trashManager: TrashManager | null = null;

  aboutToAppear() {
    const context = this.getUIContext().getHostContext() as Context;
    this.trashManager = TrashManager.getInstance(context);
    this.loadTrashFiles();
  }

  // åŠ è½½å›žæ”¶ç«™æ–‡ä»¶
  private loadTrashFiles() {
    if (this.trashManager) {
      this.trashFiles = this.trashManager.getTrashFiles();
    }
  }

  // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
  private showToast(message: string, type: string = 'success') {
    this.messageText = message;
    this.messageType = type;
    this.showMessage = true;
    setTimeout(() => {
      this.showMessage = false;
    }, 3000);
  }

  // æ¢å¤å•ä¸ªæ–‡ä»¶
  private restoreFile(trashName: string) {
    if (!this.trashManager) return;

    const success = this.trashManager.restoreFile(trashName);
    if (success) {
      this.showToast('æ–‡ä»¶å·²æ¢å¤', 'success');
      this.loadTrashFiles();
    } else {
      this.showToast('æ¢å¤å¤±è´¥', 'error');
    }
  }

  // æ°¸ä¹…åˆ é™¤å•ä¸ªæ–‡ä»¶
  private permanentDelete(trashName: string) {
    if (!this.trashManager) return;

    const success = this.trashManager.permanentDelete(trashName);
    if (success) {
      this.showToast('æ–‡ä»¶å·²æ°¸ä¹…åˆ é™¤', 'success');
      this.loadTrashFiles();
    } else {
      this.showToast('åˆ é™¤å¤±è´¥', 'error');
    }
    this.showConfirmDialog = false;
  }

  // æ¢å¤æ‰€æœ‰æ–‡ä»¶
  private restoreAll() {
    if (!this.trashManager) return;

    const restoredCount = this.trashManager.restoreAll();
    this.showToast(`å·²æ¢å¤ ${restoredCount} ä¸ªæ–‡ä»¶`, 'success');
    this.loadTrashFiles();
    this.showConfirmDialog = false;
  }

  // æ¸…ç©ºå›žæ”¶ç«™
  private emptyTrash() {
    if (!this.trashManager) return;

    const success = this.trashManager.emptyTrash();
    if (success) {
      this.showToast('å›žæ”¶ç«™å·²æ¸…ç©º', 'success');
      this.loadTrashFiles();
    } else {
      this.showToast('æ¸…ç©ºå¤±è´¥', 'error');
    }
    this.showConfirmDialog = false;
  }

  // èŽ·å–åˆ é™¤æ¥æºæ–‡å­—
  private getSourceText(source: string): string {
    switch (source) {
      case 'manual':
        return 'æ‰‹åŠ¨åˆ é™¤';
      case 'dedup':
        return 'åŽ»é‡åˆ é™¤';
      default:
        return 'åˆ é™¤';
    }
  }

  // èŽ·å–åˆ é™¤æ¥æºé¢œè‰²
  private getSourceColor(source: string): string {
    switch (source) {
      case 'manual':
        return '#007AFF';
      case 'dedup':
        return '#FF9500';
      default:
        return '#8E8E93';
    }
  }

  build() {
    Column() {
      // === é¡¶éƒ¨æ ‡é¢˜ ===
      Column() {
        Text('å›žæ”¶ç«™')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .margin({ bottom: 4 })

        Text(`å…± ${this.trashFiles.length} ä¸ªæ–‡ä»¶`)
          .fontSize(12)
          .fontColor('#8E8E93')
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })
      .alignItems(HorizontalAlign.Start)

      // === æ“ä½œæŒ‰é’®åŒº ===
      Row({ space: 10 }) {
        Button('åˆ·æ–°')
          .onClick(() => this.loadTrashFiles())
          .height(40)
          .fontSize(14)
          .backgroundColor('#007AFF')
          .fontColor(Color.White)
          .borderRadius(8)
          .layoutWeight(1)

        Button('å…¨éƒ¨æ¢å¤')
          .onClick(() => {
            if (this.trashFiles.length > 0) {
              this.confirmAction = 'restore_all';
              this.showConfirmDialog = true;
            } else {
              this.showToast('å›žæ”¶ç«™ä¸ºç©º', 'info');
            }
          })
          .enabled(this.trashFiles.length > 0)
          .height(40)
          .fontSize(14)
          .backgroundColor(this.trashFiles.length > 0 ? '#34C759' : '#C7C7CC')
          .fontColor(Color.White)
          .borderRadius(8)
          .layoutWeight(1)

        Button('æ¸…ç©ºå›žæ”¶ç«™')
          .onClick(() => {
            if (this.trashFiles.length > 0) {
              this.confirmAction = 'empty';
              this.showConfirmDialog = true;
            } else {
              this.showToast('å›žæ”¶ç«™ä¸ºç©º', 'info');
            }
          })
          .enabled(this.trashFiles.length > 0)
          .height(40)
          .fontSize(14)
          .backgroundColor(this.trashFiles.length > 0 ? '#FF3B30' : '#C7C7CC')
          .fontColor(Color.White)
          .borderRadius(8)
          .layoutWeight(1)
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 12 })

      // === æ¶ˆæ¯æç¤º ===
      if (this.showMessage) {
        Text(this.messageText)
          .fontSize(14)
          .fontColor('#FFFFFF')
          .backgroundColor(
            this.messageType === 'success' ? '#34C759' :
              (this.messageType === 'error' ? '#FF3B30' : '#007AFF')
          )
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .borderRadius(8)
          .margin({ left: 16, right: 16, bottom: 8 })
      }

      // === æ–‡ä»¶åˆ—è¡¨ ===
      if (this.trashFiles.length === 0) {
        Column() {
          Text('ðŸ—‘ï¸')
            .fontSize(48)
            .margin({ bottom: 16 })
          Text('å›žæ”¶ç«™ä¸ºç©º')
            .fontSize(16)
            .fontColor('#8E8E93')
            .margin({ bottom: 8 })
          Text('åˆ é™¤çš„æ–‡ä»¶ä¼šæš‚å­˜åœ¨è¿™é‡Œï¼Œå¯ä»¥éšæ—¶æ¢å¤')
            .fontSize(12)
            .fontColor('#C7C7CC')
        }
        .width('100%')
        .height(300)
        .justifyContent(FlexAlign.Center)
      } else {
        List({ space: 8 }) {
          ForEach(this.trashFiles, (file: TrashFileInfo) => {
            ListItem() {
              Row() {
                Column() {
                  Row() {
                    Text(file.originalName)
                      .fontSize(15)
                      .fontWeight(FontWeight.Medium)
                      .fontColor('#333333')
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                      .layoutWeight(1)

                    Text(this.getSourceText(file.source))
                      .fontSize(10)
                      .fontColor(Color.White)
                      .backgroundColor(this.getSourceColor(file.source))
                      .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                      .borderRadius(4)
                      .margin({ left: 8 })
                  }
                  .width('100%')

                  Row() {
                    Text(file.sizeReadable)
                      .fontSize(11)
                      .fontColor('#8E8E93')
                      .margin({ right: 12 })

                    Text(`åˆ é™¤äºŽ ${file.deleteTimeFormatted}`)
                      .fontSize(11)
                      .fontColor('#8E8E93')
                  }
                  .margin({ top: 4 })
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Start)

                Row({ space: 8 }) {
                  Button('æ¢å¤')
                    .onClick(() => this.restoreFile(file.trashName))
                    .height(32)
                    .fontSize(12)
                    .backgroundColor('#34C759')
                    .fontColor(Color.White)
                    .borderRadius(16)

                  Button('åˆ é™¤')
                    .onClick(() => {
                      this.selectedTrashName = file.trashName;
                      this.confirmAction = 'delete';
                      this.showConfirmDialog = true;
                    })
                    .height(32)
                    .fontSize(12)
                    .backgroundColor('#FF3B30')
                    .fontColor(Color.White)
                    .borderRadius(16)
                }
              }
              .width('100%')
              .padding(12)
              .backgroundColor(Color.White)
              .borderRadius(12)
              .border({ width: 1, color: '#E0E0E0' })
            }
          })
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ left: 16, right: 16 })
      }

      // === æç¤ºä¿¡æ¯ ===
      if (this.trashFiles.length > 0) {
        Row() {
          Text('ðŸ’¡ æç¤ºï¼šå›žæ”¶ç«™ä¸­çš„æ–‡ä»¶ä¸ä¼šæ°¸ä¹…åˆ é™¤ï¼Œç›´åˆ°æ‚¨æ‰‹åŠ¨æ¸…ç©ºå›žæ”¶ç«™')
            .fontSize(11)
            .fontColor('#8E8E93')
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 8, bottom: 16 })
      }

      // === ç¡®è®¤å¯¹è¯æ¡† ===
      if (this.showConfirmDialog) {
        Stack()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.5)')
          .onClick(() => {
            this.showConfirmDialog = false;
          })
          .position({ x: 0, y: 0 })

        Column() {
          Text(
            this.confirmAction === 'empty' ? 'ç¡®è®¤æ¸…ç©ºå›žæ”¶ç«™' :
              (this.confirmAction === 'restore_all' ? 'ç¡®è®¤æ¢å¤æ‰€æœ‰æ–‡ä»¶' : 'ç¡®è®¤æ°¸ä¹…åˆ é™¤')
          )
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .margin({ bottom: 16 })

          Text(
            this.confirmAction === 'empty'
              ? `å³å°†æ°¸ä¹…åˆ é™¤å›žæ”¶ç«™ä¸­çš„æ‰€æœ‰ ${this.trashFiles.length} ä¸ªæ–‡ä»¶ã€‚\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`
              : (this.confirmAction === 'restore_all'
                ? `å³å°†æ¢å¤å›žæ”¶ç«™ä¸­çš„æ‰€æœ‰ ${this.trashFiles.length} ä¸ªæ–‡ä»¶åˆ°åŽŸä½ç½®ã€‚`
                : 'æ­¤æ–‡ä»¶å°†è¢«æ°¸ä¹…åˆ é™¤ï¼Œæ— æ³•æ¢å¤ã€‚')
          )
            .fontSize(14)
            .fontColor('#666666')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 24 })

          Row({ space: 16 }) {
            Button('å–æ¶ˆ')
              .onClick(() => {
                this.showConfirmDialog = false;
              })
              .height(44)
              .fontSize(16)
              .backgroundColor('#E0E0E0')
              .fontColor('#333333')
              .borderRadius(8)
              .layoutWeight(1)

            Button(this.confirmAction === 'restore_all' ? 'ç¡®è®¤æ¢å¤' : 'ç¡®è®¤åˆ é™¤')
              .onClick(() => {
                switch (this.confirmAction) {
                  case 'empty':
                    this.emptyTrash();
                    break;
                  case 'restore_all':
                    this.restoreAll();
                    break;
                  case 'delete':
                    this.permanentDelete(this.selectedTrashName);
                    break;
                }
              })
              .height(44)
              .fontSize(16)
              .backgroundColor(this.confirmAction === 'restore_all' ? '#34C759' : '#FF3B30')
              .fontColor(Color.White)
              .borderRadius(8)
              .layoutWeight(1)
          }
          .width('100%')
        }
        .width('85%')
        .padding(24)
        .backgroundColor(Color.White)
        .borderRadius(16)
        .position({ x: '7.5%', y: '30%' })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}
