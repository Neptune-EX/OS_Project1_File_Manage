/*
 * Copyright (c) 2025 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 */

import { writeFile } from '../common/utils/WriteFile';
import { common } from '@kit.AbilityKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { fileIo as fs, picker } from '@kit.CoreFileKit';

@Component
export struct ApplicationFileTab {
  @State content: string = '';
  @State fileName: string = '';
  @State statusText: string = '';
  @State statusType: string = 'info'; // info, success, error
  @State isProcessing: boolean = false;

  private async copyAllRawFilesToSandbox(): Promise<void> {
    if (this.isProcessing) return;
    this.isProcessing = true;
    this.statusText = 'Ê≠£Âú®ÂØºÂÖ•...';
    this.statusType = 'info';

    try {
      const context = getContext(this) as common.UIAbilityContext;
      const rawFileList = await context.resourceManager.getRawFileList("");

      if (rawFileList.length === 0) {
        this.statusText = 'ËµÑÊ∫êÁõÆÂΩï‰∏∫Á©∫';
        this.statusType = 'error';
        this.isProcessing = false;
        return;
      }

      let success = 0;
      for (const fileName of rawFileList) {
        try {
          const content = context.resourceManager.getRawFileContentSync(fileName);
          const targetPath = `${context.filesDir}/${fileName}`;
          const file = fs.openSync(targetPath, fs.OpenMode.READ_WRITE | fs.OpenMode.CREATE | fs.OpenMode.TRUNC);
          fs.writeSync(file.fd, content.buffer as ArrayBuffer);
          fs.closeSync(file);
          success++;
        } catch (e) {
          console.error("FileTab", `Êã∑Ë¥ù ${fileName} Â§±Ë¥•`);
        }
      }

      this.statusText = `ÂØºÂÖ•ÂÆåÊàêÔºö${success}/${rawFileList.length} ‰∏™Êñá‰ª∂`;
      this.statusType = 'success';
    } catch (error) {
      this.statusText = `ÂØºÂÖ•Â§±Ë¥•Ôºö${(error as BusinessError).message}`;
      this.statusType = 'error';
    } finally {
      this.isProcessing = false;
    }
  }

  private async importWithPicker(): Promise<void> {
    if (this.isProcessing) return;

    try {
      const context = getContext(this) as common.UIAbilityContext;
      const documentPicker = new picker.DocumentViewPicker(context);
      const options = new picker.DocumentSelectOptions();
      options.maxSelectNumber = 20;

      const uris = await documentPicker.select(options);
      if (uris.length === 0) {
        this.statusText = 'Êú™ÈÄâÊã©Êñá‰ª∂';
        this.statusType = 'info';
        return;
      }

      this.isProcessing = true;
      this.statusText = 'Ê≠£Âú®ÂØºÂÖ•...';
      this.statusType = 'info';

      let success = 0;
      for (const uri of uris) {
        try {
          const parts = uri.split('/');
          const fileName = parts[parts.length - 1];
          const srcFile = fs.openSync(uri, fs.OpenMode.READ_ONLY);
          const stat = fs.statSync(srcFile.fd);
          const buffer = new ArrayBuffer(stat.size);
          fs.readSync(srcFile.fd, buffer);
          fs.closeSync(srcFile);

          const dstPath = `${context.filesDir}/${fileName}`;
          const dstFile = fs.openSync(dstPath, fs.OpenMode.READ_WRITE | fs.OpenMode.CREATE | fs.OpenMode.TRUNC);
          fs.writeSync(dstFile.fd, buffer);
          fs.closeSync(dstFile);
          success++;
        } catch (e) {
          console.error("FileTab", "ÂØºÂÖ•Êñá‰ª∂Â§±Ë¥•:", e);
        }
      }

      this.statusText = `ÂØºÂÖ•ÂÆåÊàêÔºö${success}/${uris.length} ‰∏™Êñá‰ª∂`;
      this.statusType = 'success';
    } catch (error) {
      this.statusText = `ÈÄâÊã©Â§±Ë¥•`;
      this.statusType = 'error';
    } finally {
      this.isProcessing = false;
    }
  }

  private createFile(): void {
    const name = this.fileName.trim();
    const text = this.content.trim();

    if (name.length === 0) {
      this.statusText = 'ËØ∑ËæìÂÖ•Êñá‰ª∂Âêç';
      this.statusType = 'error';
      return;
    }

    if (text.length === 0) {
      this.statusText = 'ËØ∑ËæìÂÖ•Êñá‰ª∂ÂÜÖÂÆπ';
      this.statusType = 'error';
      return;
    }

    // Ëá™Âä®Ê∑ªÂä† .txt Êâ©Â±ïÂêç
    const finalName = name.includes('.') ? name : `${name}.txt`;

    try {
      writeFile(text, finalName);
      this.statusText = `Êñá‰ª∂ "${finalName}" ÂàõÂª∫ÊàêÂäü`;
      this.statusType = 'success';
      this.content = '';
      this.fileName = '';
    } catch (e) {
      this.statusText = 'ÂàõÂª∫Â§±Ë¥•';
      this.statusType = 'error';
    }
  }

  build() {
    Column() {
      // Ê†áÈ¢ò
      Text('Êñá‰ª∂ÂØºÂÖ•')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .width('100%')
        .padding({ left: 20, top: 16, bottom: 12 })

      // ÂØºÂÖ•Âç°Áâá
      Column() {
        Row({ space: 12 }) {
          // ËµÑÊ∫êÂØºÂÖ•
          Column() {
            Text('üì¶')
              .fontSize(28)
            Text('ËµÑÊ∫êÂØºÂÖ•')
              .fontSize(13)
              .fontColor('#333333')
              .margin({ top: 6 })
            Text('‰ªéÂ∫îÁî®ËµÑÊ∫ê')
              .fontSize(10)
              .fontColor('#8E8E93')
              .margin({ top: 2 })
          }
          .layoutWeight(1)
          .height(90)
          .backgroundColor('#E8F5E9')
          .borderRadius(12)
          .justifyContent(FlexAlign.Center)
          .onClick(() => this.copyAllRawFilesToSandbox())

          // Êñá‰ª∂ÈÄâÊã©
          Column() {
            Text('üìÅ')
              .fontSize(28)
            Text('ÈÄâÊã©Êñá‰ª∂')
              .fontSize(13)
              .fontColor('#333333')
              .margin({ top: 6 })
            Text('‰ªéËÆæÂ§áÂ≠òÂÇ®')
              .fontSize(10)
              .fontColor('#8E8E93')
              .margin({ top: 2 })
          }
          .layoutWeight(1)
          .height(90)
          .backgroundColor('#E3F2FD')
          .borderRadius(12)
          .justifyContent(FlexAlign.Center)
          .onClick(() => this.importWithPicker())
        }
        .width('100%')

        // Áä∂ÊÄÅÊèêÁ§∫
        if (this.statusText.length > 0) {
          Row() {
            Text(this.statusType === 'success' ? '‚úì' : (this.statusType === 'error' ? '‚úó' : '‚Ñπ'))
              .fontSize(14)
              .fontColor(
                this.statusType === 'success' ? '#34C759' :
                  (this.statusType === 'error' ? '#FF3B30' : '#007AFF')
              )
            Text(this.statusText)
              .fontSize(13)
              .fontColor('#666666')
              .margin({ left: 6 })
          }
          .width('100%')
          .margin({ top: 12 })
          .justifyContent(FlexAlign.Center)
        }
      }
      .width('100%')
      .padding(16)
      .margin({ left: 16, right: 16 })
      .backgroundColor(Color.White)
      .borderRadius(16)

      // ÂàõÂª∫Êñá‰ª∂Ê†áÈ¢ò
      Text('ÂàõÂª∫Êñ∞Êñá‰ª∂')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .width('100%')
        .padding({ left: 20, top: 24, bottom: 12 })

      // ÂàõÂª∫Êñá‰ª∂Âç°Áâá
      Column() {
        // Êñá‰ª∂ÂêçËæìÂÖ•
        Column() {
          Text('Êñá‰ª∂Âêç')
            .fontSize(13)
            .fontColor('#8E8E93')
            .width('100%')
            .margin({ bottom: 6 })

          TextInput({ placeholder: '‰æãÂ¶ÇÔºöÁ¨îËÆ∞„ÄÅ‰ºöËÆÆËÆ∞ÂΩï', text: this.fileName })
            .width('100%')
            .height(44)
            .backgroundColor('#F5F5F5')
            .borderRadius(10)
            .padding({ left: 12, right: 12 })
            .onChange((value: string) => {
              this.fileName = value;
            })
        }
        .width('100%')
        .margin({ bottom: 16 })

        // ÂÜÖÂÆπËæìÂÖ•
        Column() {
          Text('Êñá‰ª∂ÂÜÖÂÆπ')
            .fontSize(13)
            .fontColor('#8E8E93')
            .width('100%')
            .margin({ bottom: 6 })

          TextArea({ placeholder: 'Âú®Ê≠§ËæìÂÖ•Êñá‰ª∂ÂÜÖÂÆπ...', text: this.content })
            .width('100%')
            .height(120)
            .backgroundColor('#F5F5F5')
            .borderRadius(10)
            .padding(12)
            .onChange((value: string) => {
              this.content = value;
            })
        }
        .width('100%')
        .margin({ bottom: 16 })

        // ÂàõÂª∫ÊåâÈíÆ
        Button('ÂàõÂª∫Êñá‰ª∂')
          .width('100%')
          .height(46)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .backgroundColor('#007AFF')
          .fontColor(Color.White)
          .borderRadius(10)
          .onClick(() => this.createFile())
      }
      .width('100%')
      .padding(16)
      .margin({ left: 16, right: 16 })
      .backgroundColor(Color.White)
      .borderRadius(16)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}
