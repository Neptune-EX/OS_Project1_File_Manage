/*
 * æ–‡ä»¶åŽ»é‡é¡µé¢ç»„ä»¶
 */

import { DeduplicationManager, DuplicateGroup, FileItem, ScanResult, DirectoryInfo } from '../common/utils/DeduplicationManager';
import { picker } from '@kit.CoreFileKit';

// åŽ»é‡ç»Ÿè®¡ä¿¡æ¯æŽ¥å£
interface DeduplicateStats {
  keep: number;
  deleteCount: number;
  saveSpace: number;
}

@Component
export struct DeduplicationTab {
  // åŽ»é‡ç®¡ç†å™¨
  @State deduplicationManager: DeduplicationManager | null = null;

  // ç›®å½•é€‰æ‹©
  @State availableDirectories: DirectoryInfo[] = [];
  @State selectedDirectories: string[] = [];

  // æ‰«æçŠ¶æ€
  @State isScanning: boolean = false;
  @State scanProgress: string = '';
  @State hasScanned: boolean = false;

  // æ‰«æç»“æžœ
  @State scanResult: ScanResult | null = null;
  @State duplicateGroups: DuplicateGroup[] = [];

  // æ¶ˆæ¯æç¤º
  @State showMessage: boolean = false;
  @State messageText: string = '';
  @State messageType: 'success' | 'error' | 'info' = 'info';

  // ç¡®è®¤å¯¹è¯æ¡†
  @State showConfirmDialog: boolean = false;
  @State confirmAction: 'deduplicate' | 'delete' | 'clearTest' = 'deduplicate';
  @State pendingDeleteFile: FileItem | null = null;

  // å¯¼å…¥æµ‹è¯•æ–‡ä»¶çŠ¶æ€
  @State isImporting: boolean = false;
  @State importedFileCount: number = 0;
  @State testFolderFileCount: number = 0;

  aboutToAppear() {
    let context = this.getUIContext().getHostContext() as Context;
    this.deduplicationManager = new DeduplicationManager(context);
    this.loadDirectories();
    this.updateTestFolderCount();
  }

  // æ›´æ–°æµ‹è¯•æ–‡ä»¶å¤¹æ–‡ä»¶æ•°é‡
  private updateTestFolderCount() {
    if (this.deduplicationManager) {
      this.testFolderFileCount = this.deduplicationManager.getTestFolderFileCount();
    }
  }

  // åŠ è½½å¯ç”¨ç›®å½•
  private loadDirectories() {
    if (this.deduplicationManager) {
      this.availableDirectories = this.deduplicationManager.getAvailableDirectories();
      // é»˜è®¤é€‰ä¸­ä¸»ç›®å½•
      if (this.availableDirectories.length > 0) {
        this.selectedDirectories = [this.availableDirectories[0].path];
        this.availableDirectories[0].selected = true;
      }
    }
  }

  // åˆ‡æ¢ç›®å½•é€‰æ‹©
  private toggleDirectorySelection(dir: DirectoryInfo) {
    dir.selected = !dir.selected;
    if (dir.selected) {
      if (!this.selectedDirectories.includes(dir.path)) {
        this.selectedDirectories.push(dir.path);
      }
    } else {
      this.selectedDirectories = this.selectedDirectories.filter(p => p !== dir.path);
    }
    // è§¦å‘æ›´æ–°
    this.availableDirectories = [...this.availableDirectories];
  }

  // å¯¼å…¥æµ‹è¯•æ–‡ä»¶
  private async importTestFiles() {
    if (!this.deduplicationManager) return;

    try {
      // åˆ›å»ºæ–‡ä»¶é€‰æ‹©å™¨
      const documentPicker = new picker.DocumentViewPicker();

      // é…ç½®é€‰æ‹©é€‰é¡¹
      const options = new picker.DocumentSelectOptions();
      options.maxSelectNumber = 100; // æœ€å¤šé€‰æ‹©100ä¸ªæ–‡ä»¶

      this.isImporting = true;
      this.importedFileCount = 0;

      // æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
      const result = await documentPicker.select(options);

      if (result && result.length > 0) {
        console.log(`é€‰æ‹©äº† ${result.length} ä¸ªæ–‡ä»¶`);

        // ç¡®ä¿æµ‹è¯•æ–‡ä»¶å¤¹å­˜åœ¨
        this.deduplicationManager.createTestFolder();

        let successCount = 0;
        for (const uri of result) {
          // ä»Ž URI æå–æ–‡ä»¶å
          const parts = uri.split('/');
          const fileName = parts[parts.length - 1] || `file_${Date.now()}`;

          const success = await this.deduplicationManager.importFileToTestFolder(uri, fileName);
          if (success) {
            successCount++;
          }
        }

        this.importedFileCount = successCount;
        this.updateTestFolderCount();
        this.loadDirectories(); // åˆ·æ–°ç›®å½•åˆ—è¡¨

        if (successCount > 0) {
          this.showToast(`æˆåŠŸå¯¼å…¥ ${successCount} ä¸ªæ–‡ä»¶`, 'success');
        } else {
          this.showToast('å¯¼å…¥å¤±è´¥', 'error');
        }
      } else {
        this.showToast('æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶', 'info');
      }
    } catch (error) {
      console.error('å¯¼å…¥æ–‡ä»¶å¤±è´¥:', error);
      this.showToast('å¯¼å…¥å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    } finally {
      this.isImporting = false;
    }
  }

  // æ¸…ç©ºæµ‹è¯•æ–‡ä»¶å¤¹
  private prepareClearTestFolder() {
    this.confirmAction = 'clearTest';
    this.showConfirmDialog = true;
  }

  private executeClearTestFolder() {
    if (!this.deduplicationManager) return;

    const deletedCount = this.deduplicationManager.clearTestFolder();
    this.showConfirmDialog = false;
    this.updateTestFolderCount();
    this.loadDirectories();

    if (deletedCount > 0) {
      this.showToast(`å·²æ¸…ç©º ${deletedCount} ä¸ªæµ‹è¯•æ–‡ä»¶`, 'success');
    } else {
      this.showToast('æµ‹è¯•æ–‡ä»¶å¤¹å·²ä¸ºç©º', 'info');
    }
  }

  // å¼€å§‹æ‰«æ
  private async startScan() {
    if (!this.deduplicationManager || this.selectedDirectories.length === 0) {
      this.showToast('è¯·å…ˆé€‰æ‹©è¦æ‰«æçš„ç›®å½•', 'error');
      return;
    }

    this.isScanning = true;
    this.scanProgress = 'æ­£åœ¨æ‰«ææ–‡ä»¶...';
    this.hasScanned = false;

    try {
      const result = await this.deduplicationManager.scanForDuplicates(this.selectedDirectories);
      this.scanResult = result;
      this.duplicateGroups = this.deduplicationManager.getDuplicateGroups();
      this.hasScanned = true;

      if (result.duplicateGroups === 0) {
        this.showToast('æœªå‘çŽ°é‡å¤æ–‡ä»¶', 'info');
      } else {
        this.showToast(`å‘çŽ° ${result.duplicateGroups} ç»„é‡å¤æ–‡ä»¶`, 'success');
      }
    } catch (error) {
      console.error('æ‰«æå¤±è´¥:', error);
      this.showToast('æ‰«æå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    } finally {
      this.isScanning = false;
      this.scanProgress = '';
    }
  }

  // åˆ‡æ¢ç»„å±•å¼€çŠ¶æ€
  private toggleGroupExpanded(group: DuplicateGroup) {
    group.expanded = !group.expanded;
    this.duplicateGroups = [...this.duplicateGroups];
  }

  // åˆ‡æ¢æ–‡ä»¶é€‰ä¸­çŠ¶æ€
  private toggleFileSelection(group: DuplicateGroup, file: FileItem) {
    file.selected = !file.selected;
    this.duplicateGroups = [...this.duplicateGroups];
  }

  // ä¸€é”®åŽ»é‡å‡†å¤‡
  private prepareAutoDeduplicate() {
    if (!this.deduplicationManager || this.duplicateGroups.length === 0) {
      return;
    }
    this.deduplicationManager.autoSelectForDeduplicate();
    this.duplicateGroups = [...this.deduplicationManager.getDuplicateGroups()];
    this.confirmAction = 'deduplicate';
    this.showConfirmDialog = true;
  }

  // æ‰§è¡ŒåŽ»é‡
  private executeDeduplicate() {
    if (!this.deduplicationManager) return;

    const deletedCount = this.deduplicationManager.executeDeduplicate();
    this.showConfirmDialog = false;

    if (deletedCount > 0) {
      this.showToast(`æˆåŠŸåˆ é™¤ ${deletedCount} ä¸ªé‡å¤æ–‡ä»¶`, 'success');
      // é‡æ–°æ‰«æä»¥åˆ·æ–°ç»“æžœ
      this.startScan();
    } else {
      this.showToast('æ²¡æœ‰æ–‡ä»¶è¢«åˆ é™¤', 'info');
    }
  }

  // æ‰‹åŠ¨åˆ é™¤å•ä¸ªæ–‡ä»¶
  private deleteOneFile(file: FileItem) {
    this.pendingDeleteFile = file;
    this.confirmAction = 'delete';
    this.showConfirmDialog = true;
  }

  // ç¡®è®¤åˆ é™¤å•ä¸ªæ–‡ä»¶
  private confirmDeleteOneFile() {
    if (!this.deduplicationManager || !this.pendingDeleteFile) return;

    const success = this.deduplicationManager.deleteFile(this.pendingDeleteFile.path);
    this.showConfirmDialog = false;

    if (success) {
      this.showToast(`å·²åˆ é™¤: ${this.pendingDeleteFile.filename}`, 'success');
      // é‡æ–°æ‰«æä»¥åˆ·æ–°ç»“æžœ
      this.startScan();
    } else {
      this.showToast('åˆ é™¤å¤±è´¥', 'error');
    }

    this.pendingDeleteFile = null;
  }

  // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
  private showToast(message: string, type: 'success' | 'error' | 'info') {
    this.messageText = message;
    this.messageType = type;
    this.showMessage = true;

    setTimeout(() => {
      this.showMessage = false;
    }, 3000);
  }

  // èŽ·å–æ¶ˆæ¯èƒŒæ™¯è‰²
  private getMessageColor(): string {
    switch (this.messageType) {
      case 'success': return '#34C759';
      case 'error': return '#FF3B30';
      case 'info': return '#007AFF';
    }
  }

  // èŽ·å–ä¿ç•™æ–‡ä»¶æ•°å’Œåˆ é™¤æ–‡ä»¶æ•°
  private getDeduplicateStats(): DeduplicateStats {
    let keep = 0;
    let del = 0;
    let saveSpace = 0;

    for (const group of this.duplicateGroups) {
      for (const file of group.files) {
        if (file.selected) {
          keep++;
        } else {
          del++;
          saveSpace += file.size;
        }
      }
    }

    const result: DeduplicateStats = {
      keep: keep,
      deleteCount: del,
      saveSpace: saveSpace
    };
    return result;
  }

  build() {
    Stack() {
      Column() {
        // === é¡¶éƒ¨æ ‡é¢˜æ  ===
        Row() {
          Text('ðŸ“ æ–‡ä»¶åŽ»é‡')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 8 })

        // === æ¶ˆæ¯æç¤º ===
        if (this.showMessage) {
          Text(this.messageText)
            .fontSize(14)
            .fontColor('#FFFFFF')
            .backgroundColor(this.getMessageColor())
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .borderRadius(8)
            .margin({ left: 16, right: 16, bottom: 8 })
        }

        Scroll() {
          Column() {
            // === å¯¼å…¥æµ‹è¯•æ•°æ®åŒºåŸŸ ===
            Column() {
              Row() {
                Text('ðŸ“¥ å¯¼å…¥æµ‹è¯•æ•°æ®')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')
                  .layoutWeight(1)

                if (this.testFolderFileCount > 0) {
                  Text(`å·²å¯¼å…¥ ${this.testFolderFileCount} ä¸ªæ–‡ä»¶`)
                    .fontSize(12)
                    .fontColor('#34C759')
                    .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                    .backgroundColor('#E8F5E9')
                    .borderRadius(10)
                }
              }
              .width('100%')
              .margin({ bottom: 10 })

              Text('ä»Žè®¾å¤‡é€‰æ‹©æµ‹è¯•æ–‡ä»¶å¯¼å…¥åˆ°åº”ç”¨ä¸­ï¼Œç”¨äºŽåŽ»é‡æµ‹è¯•éªŒè¯')
                .fontSize(13)
                .fontColor('#666666')
                .width('100%')
                .margin({ bottom: 12 })

              Row() {
                Button(this.isImporting ? 'å¯¼å…¥ä¸­...' : 'é€‰æ‹©æ–‡ä»¶å¯¼å…¥')
                  .layoutWeight(1)
                  .height(40)
                  .fontSize(14)
                  .fontColor('#FFFFFF')
                  .backgroundColor(this.isImporting ? '#999999' : '#5856D6')
                  .borderRadius(10)
                  .enabled(!this.isImporting)
                  .onClick(() => {
                    this.importTestFiles();
                  })

                if (this.testFolderFileCount > 0) {
                  Button('æ¸…ç©º')
                    .width(70)
                    .height(40)
                    .fontSize(14)
                    .fontColor('#FFFFFF')
                    .backgroundColor('#FF3B30')
                    .borderRadius(10)
                    .margin({ left: 10 })
                    .onClick(() => {
                      this.prepareClearTestFolder();
                    })
                }
              }
              .width('100%')
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .margin({ left: 12, right: 12, top: 8, bottom: 8 })

            // === ç›®å½•é€‰æ‹©åŒºåŸŸ ===
            Column() {
              Text('é€‰æ‹©æ‰«æç›®å½•')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .width('100%')
                .margin({ bottom: 10 })

              if (this.availableDirectories.length === 0) {
                Text('æš‚æ— å¯æ‰«æç›®å½•')
                  .fontSize(14)
                  .fontColor('#999999')
                  .padding(20)
              } else {
                ForEach(this.availableDirectories, (dir: DirectoryInfo) => {
                  Row() {
                    Checkbox()
                      .select(dir.selected)
                      .onChange((value: boolean) => {
                        this.toggleDirectorySelection(dir);
                      })
                      .margin({ right: 10 })

                    Column() {
                      Text(dir.name)
                        .fontSize(14)
                        .fontWeight(FontWeight.Medium)
                        .fontColor('#333333')
                      Text(dir.path)
                        .fontSize(11)
                        .fontColor('#999999')
                        .maxLines(1)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })
                    }
                    .alignItems(HorizontalAlign.Start)
                    .layoutWeight(1)
                  }
                  .width('100%')
                  .padding({ top: 8, bottom: 8 })
                  .onClick(() => {
                    this.toggleDirectorySelection(dir);
                  })
                })
              }

              // æ‰«ææŒ‰é’®
              Button(this.isScanning ? 'æ‰«æä¸­...' : 'å¼€å§‹æ‰«æ')
                .width('100%')
                .height(44)
                .fontSize(16)
                .fontColor('#FFFFFF')
                .backgroundColor(this.isScanning ? '#999999' : '#007AFF')
                .borderRadius(10)
                .margin({ top: 12 })
                .enabled(!this.isScanning)
                .onClick(() => {
                  this.startScan();
                })

              if (this.isScanning) {
                Text(this.scanProgress)
                  .fontSize(13)
                  .fontColor('#666666')
                  .margin({ top: 8 })
              }
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .margin({ left: 12, right: 12, top: 8, bottom: 8 })

            // === æ‰«æç»“æžœç»Ÿè®¡ ===
            if (this.hasScanned && this.scanResult) {
              Column() {
                Text('æ‰«æç»“æžœ')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')
                  .width('100%')
                  .margin({ bottom: 10 })

                Row() {
                  this.StatCard('æ€»æ–‡ä»¶', `${this.scanResult.totalFiles}`, '#007AFF')
                  this.StatCard('é‡å¤ç»„', `${this.scanResult.duplicateGroups}`, '#FF9500')
                  this.StatCard('å¯èŠ‚çœ', this.scanResult.savableSpaceReadable, '#34C759')
                }
                .width('100%')
                .justifyContent(FlexAlign.SpaceBetween)
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFFFF')
              .borderRadius(12)
              .margin({ left: 12, right: 12, bottom: 8 })
            }

            // === é‡å¤æ–‡ä»¶ç»„åˆ—è¡¨ ===
            if (this.hasScanned && this.duplicateGroups.length > 0) {
              Column() {
                Row() {
                  Text('é‡å¤æ–‡ä»¶ç»„')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#333333')
                    .layoutWeight(1)

                  Button('ä¸€é”®åŽ»é‡')
                    .height(32)
                    .fontSize(13)
                    .fontColor('#FFFFFF')
                    .backgroundColor('#FF3B30')
                    .borderRadius(16)
                    .onClick(() => {
                      this.prepareAutoDeduplicate();
                    })
                }
                .width('100%')
                .margin({ bottom: 12 })

                ForEach(this.duplicateGroups, (group: DuplicateGroup) => {
                  Column() {
                    // ç»„å¤´éƒ¨
                    Row() {
                      Text(group.expanded ? 'â–¼' : 'â–¶')
                        .fontSize(14)
                        .fontColor('#666666')
                        .margin({ right: 8 })

                      Column() {
                        Row() {
                          Text(`${group.files.length} ä¸ªç›¸åŒæ–‡ä»¶`)
                            .fontSize(14)
                            .fontWeight(FontWeight.Medium)
                            .fontColor('#333333')

                          Text(`(${group.sizeReadable})`)
                            .fontSize(12)
                            .fontColor('#999999')
                            .margin({ left: 8 })
                        }

                        Text(`å“ˆå¸Œ: ${group.hash.substring(0, 16)}...`)
                          .fontSize(11)
                          .fontColor('#AAAAAA')
                      }
                      .alignItems(HorizontalAlign.Start)
                      .layoutWeight(1)
                    }
                    .width('100%')
                    .padding(12)
                    .onClick(() => {
                      this.toggleGroupExpanded(group);
                    })

                    // æ–‡ä»¶åˆ—è¡¨ï¼ˆå±•å¼€æ—¶æ˜¾ç¤ºï¼‰
                    if (group.expanded) {
                      Column() {
                        ForEach(group.files, (file: FileItem) => {
                          Row() {
                            Checkbox()
                              .select(file.selected)
                              .onChange(() => {
                                this.toggleFileSelection(group, file);
                              })
                              .margin({ right: 10 })

                            Column() {
                              Text(file.filename)
                                .fontSize(13)
                                .fontWeight(FontWeight.Medium)
                                .fontColor(file.selected ? '#007AFF' : '#333333')
                                .maxLines(1)
                                .textOverflow({ overflow: TextOverflow.Ellipsis })

                              Text(file.path)
                                .fontSize(10)
                                .fontColor('#999999')
                                .maxLines(1)
                                .textOverflow({ overflow: TextOverflow.Ellipsis })
                            }
                            .alignItems(HorizontalAlign.Start)
                            .layoutWeight(1)

                            if (file.selected) {
                              Text('ä¿ç•™')
                                .fontSize(11)
                                .fontColor('#FFFFFF')
                                .backgroundColor('#34C759')
                                .padding({ left: 8, right: 8, top: 3, bottom: 3 })
                                .borderRadius(10)
                            } else {
                              Button('åˆ é™¤')
                                .height(26)
                                .fontSize(11)
                                .fontColor('#FFFFFF')
                                .backgroundColor('#FF3B30')
                                .borderRadius(13)
                                .onClick(() => {
                                  this.deleteOneFile(file);
                                })
                            }
                          }
                          .width('100%')
                          .padding({ left: 12, right: 12, top: 8, bottom: 8 })
                          .backgroundColor(file.selected ? '#F0F8FF' : '#FAFAFA')
                          .borderRadius(8)
                          .margin({ bottom: 4 })
                        })
                      }
                      .padding({ left: 12, right: 12, bottom: 12 })
                    }
                  }
                  .width('100%')
                  .backgroundColor('#FFFAF0')
                  .border({ width: 1, color: '#FF9500', radius: 10 })
                  .margin({ bottom: 10 })
                })
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFFFF')
              .borderRadius(12)
              .margin({ left: 12, right: 12, bottom: 100 })
            }

            // === æ— é‡å¤æ–‡ä»¶æç¤º ===
            if (this.hasScanned && this.duplicateGroups.length === 0) {
              Column() {
                Text('âœ…')
                  .fontSize(48)
                  .margin({ bottom: 12 })
                Text('å¤ªæ£’äº†ï¼æ²¡æœ‰å‘çŽ°é‡å¤æ–‡ä»¶')
                  .fontSize(16)
                  .fontColor('#34C759')
                  .fontWeight(FontWeight.Medium)
              }
              .width('100%')
              .padding(40)
              .backgroundColor('#FFFFFF')
              .borderRadius(12)
              .margin({ left: 12, right: 12, bottom: 8 })
            }
          }
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')

      // === ç¡®è®¤å¯¹è¯æ¡† ===
      if (this.showConfirmDialog) {
        Stack() {
          // èƒŒæ™¯é®ç½©
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0, 0, 0, 0.5)')
            .onClick(() => {
              this.showConfirmDialog = false;
            })

          // å¯¹è¯æ¡†å†…å®¹
          Column() {
            Text(this.confirmAction === 'deduplicate' ? 'ç¡®è®¤ä¸€é”®åŽ»é‡' :
                 this.confirmAction === 'clearTest' ? 'ç¡®è®¤æ¸…ç©ºæµ‹è¯•æ•°æ®' : 'ç¡®è®¤åˆ é™¤')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .margin({ bottom: 16 })

            if (this.confirmAction === 'deduplicate') {
              Column() {
                Text(`å³å°†åˆ é™¤ ${this.getDeduplicateStats().deleteCount} ä¸ªé‡å¤æ–‡ä»¶`)
                  .fontSize(14)
                  .fontColor('#666666')
                Text(`ä¿ç•™ ${this.getDeduplicateStats().keep} ä¸ªæ–‡ä»¶`)
                  .fontSize(14)
                  .fontColor('#666666')
                Text(`å¯èŠ‚çœç©ºé—´: ${this.scanResult?.savableSpaceReadable || '0 B'}`)
                  .fontSize(14)
                  .fontColor('#34C759')
                  .margin({ top: 8 })
              }
              .margin({ bottom: 20 })
            } else if (this.confirmAction === 'clearTest') {
              Text(`ç¡®å®šæ¸…ç©ºæµ‹è¯•æ–‡ä»¶å¤¹ä¸­çš„ ${this.testFolderFileCount} ä¸ªæ–‡ä»¶å—ï¼Ÿ`)
                .fontSize(14)
                .fontColor('#666666')
                .margin({ bottom: 20 })
            } else if (this.pendingDeleteFile) {
              Text(`ç¡®å®šåˆ é™¤æ–‡ä»¶ "${this.pendingDeleteFile.filename}" å—ï¼Ÿ`)
                .fontSize(14)
                .fontColor('#666666')
                .margin({ bottom: 20 })
            }

            Text('âš ï¸ æ­¤æ“ä½œä¸å¯æ¢å¤ï¼')
              .fontSize(13)
              .fontColor('#FF3B30')
              .margin({ bottom: 20 })

            Row() {
              Button('å–æ¶ˆ')
                .width('45%')
                .height(44)
                .fontSize(15)
                .fontColor('#333333')
                .backgroundColor('#E5E5E5')
                .borderRadius(10)
                .onClick(() => {
                  this.showConfirmDialog = false;
                  this.pendingDeleteFile = null;
                })

              Button('ç¡®è®¤')
                .width('45%')
                .height(44)
                .fontSize(15)
                .fontColor('#FFFFFF')
                .backgroundColor('#FF3B30')
                .borderRadius(10)
                .onClick(() => {
                  if (this.confirmAction === 'deduplicate') {
                    this.executeDeduplicate();
                  } else if (this.confirmAction === 'clearTest') {
                    this.executeClearTestFolder();
                  } else {
                    this.confirmDeleteOneFile();
                  }
                })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
          }
          .width('85%')
          .padding(24)
          .backgroundColor('#FFFFFF')
          .borderRadius(16)
        }
        .width('100%')
        .height('100%')
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  StatCard(label: string, value: string, color: string) {
    Column() {
      Text(value)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)
      Text(label)
        .fontSize(12)
        .fontColor('#999999')
        .margin({ top: 4 })
    }
    .padding({ top: 12, bottom: 12, left: 16, right: 16 })
    .backgroundColor('#F8F8F8')
    .borderRadius(10)
    .width('30%')
  }
}
