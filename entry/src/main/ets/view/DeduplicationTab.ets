/*
 * Êñá‰ª∂ÂéªÈáçTabÈ°µÈù¢ - ÂÆûÁé∞ÈáçÂ§çÊñá‰ª∂Êâ´Êèè„ÄÅÂ±ïÁ§∫ÂíåÂéªÈáçÂäüËÉΩ
 */

import { DuplicateScanner, DuplicateGroup, DuplicateFileInfo, ScanResult } from '../common/utils/DuplicateScanner';

@Component
export struct DeduplicationTab {
  @State scanResult: ScanResult | null = null;
  @State isScanning: boolean = false;
  @State expandedGroups: string[] = [];
  @State showMessage: boolean = false;
  @State messageText: string = '';
  @State messageType: string = 'success'; // 'success' | 'error' | 'info'
  @State lastScanTime: string = '';
  @State showConfirmDialog: boolean = false;
  @State confirmAction: string = ''; // 'dedup_all' | 'dedup_group'
  @State selectedGroupHash: string = '';
  @State selectedKeepFile: string = '';

  private scanner: DuplicateScanner | null = null;

  aboutToAppear() {
    const context = this.getUIContext().getHostContext() as Context;
    this.scanner = DuplicateScanner.getInstance(context);
    this.lastScanTime = this.scanner.getLastScanTimeFormatted();
  }

  // ÊòæÁ§∫Ê∂àÊÅØÊèêÁ§∫
  private showToast(message: string, type: string = 'success') {
    this.messageText = message;
    this.messageType = type;
    this.showMessage = true;
    setTimeout(() => {
      this.showMessage = false;
    }, 3000);
  }

  // ÊâßË°åÂÖ®ÈáèÊâ´Êèè
  private async performFullScan() {
    if (!this.scanner || this.isScanning) return;

    this.isScanning = true;
    this.showToast('Ê≠£Âú®Êâ´ÊèèÊñá‰ª∂...', 'info');

    try {
      // ‰ΩøÁî® setTimeout ËÆ© UI ÊúâÊó∂Èó¥Êõ¥Êñ∞
      setTimeout(() => {
        if (this.scanner) {
          this.scanResult = this.scanner.fullScan();
          this.lastScanTime = this.scanner.getLastScanTimeFormatted();
          this.isScanning = false;

          if (this.scanResult.duplicateGroups.length === 0) {
            this.showToast('Êâ´ÊèèÂÆåÊàêÔºåÊú™ÂèëÁé∞ÈáçÂ§çÊñá‰ª∂', 'info');
          } else {
            this.showToast(
              `Êâ´ÊèèÂÆåÊàêÔºÅÂèëÁé∞ ${this.scanResult.duplicateGroups.length} ÁªÑÈáçÂ§çÊñá‰ª∂Ôºå` +
              `ÂèØËäÇÁúÅ ${this.scanResult.totalWasteSizeReadable} Á©∫Èó¥`,
              'success'
            );
          }
        }
      }, 100);
    } catch (error) {
      this.isScanning = false;
      this.showToast(`Êâ´ÊèèÂ§±Ë¥•: ${error}`, 'error');
    }
  }

  // ÊâßË°åÂ¢ûÈáèÊâ´Êèè
  private async performIncrementalScan() {
    if (!this.scanner || this.isScanning) return;

    this.isScanning = true;
    this.showToast('Ê≠£Âú®ÊâßË°åÂ¢ûÈáèÊâ´Êèè...', 'info');

    try {
      setTimeout(() => {
        if (this.scanner) {
          this.scanResult = this.scanner.incrementalScan();
          this.lastScanTime = this.scanner.getLastScanTimeFormatted();
          this.isScanning = false;

          if (this.scanResult.changedFiles === 0) {
            this.showToast('Â¢ûÈáèÊâ´ÊèèÂÆåÊàêÔºåÊñá‰ª∂Êó†ÂèòÂåñ', 'info');
          } else {
            this.showToast(
              `Â¢ûÈáèÊâ´ÊèèÂÆåÊàêÔºÅÊ£ÄÊµãÂà∞ ${this.scanResult.changedFiles} ‰∏™Êñá‰ª∂ÂèòÊõ¥`,
              'success'
            );
          }
        }
      }, 100);
    } catch (error) {
      this.isScanning = false;
      this.showToast(`Êâ´ÊèèÂ§±Ë¥•: ${error}`, 'error');
    }
  }

  // ‰∏ÄÈîÆÂéªÈáç
  private performDeduplicateAll() {
    if (!this.scanner) return;

    const deletedCount = this.scanner.deduplicateAll();
    this.scanResult = this.scanner.fullScan();

    this.showToast(`‰∏ÄÈîÆÂéªÈáçÂÆåÊàêÔºÅÂ∑≤Âà†Èô§ ${deletedCount} ‰∏™ÈáçÂ§çÊñá‰ª∂`, 'success');
    this.showConfirmDialog = false;
  }

  // Â§ÑÁêÜÂçï‰∏™ÈáçÂ§çÁªÑ
  private performDeduplicateGroup() {
    if (!this.scanner || !this.selectedGroupHash || !this.selectedKeepFile) return;

    const deletedCount = this.scanner.deduplicateGroup(this.selectedGroupHash, this.selectedKeepFile);
    this.scanResult = this.scanner.fullScan();

    this.showToast(`Â∑≤Âà†Èô§ ${deletedCount} ‰∏™ÈáçÂ§çÊñá‰ª∂Ôºå‰øùÁïô "${this.selectedKeepFile}"`, 'success');
    this.showConfirmDialog = false;
    this.expandedGroups = this.expandedGroups.filter(h => h !== this.selectedGroupHash);
  }

  // ÂàáÊç¢ÁªÑÂ±ïÂºÄÁä∂ÊÄÅ
  private toggleGroup(hash: string) {
    const index = this.expandedGroups.indexOf(hash);
    if (index >= 0) {
      this.expandedGroups = this.expandedGroups.filter(h => h !== hash);
    } else {
      this.expandedGroups = this.expandedGroups.concat([hash]);
    }
  }

  // Ê£ÄÊü•ÁªÑÊòØÂê¶Â±ïÂºÄ
  private isGroupExpanded(hash: string): boolean {
    return this.expandedGroups.indexOf(hash) >= 0;
  }

  // Ëé∑ÂèñÂèòÊõ¥Áä∂ÊÄÅÊñáÂ≠ó
  private getChangeStatusText(group: DuplicateGroup): string {
    if (!group.changeStatus) return '';

    switch (group.changeStatus) {
      case 'new':
        return `Êñ∞Â¢ûÈáçÂ§çÁªÑ (+${group.changeCount})`;
      case 'increased':
        return `ÈáçÂ§çÊï∞Â¢ûÂä† (+${group.changeCount})`;
      case 'decreased':
        return `ÈáçÂ§çÊï∞ÂáèÂ∞ë (-${group.changeCount})`;
      default:
        return '';
    }
  }

  // Ëé∑ÂèñÂèòÊõ¥Áä∂ÊÄÅÈ¢úËâ≤
  private getChangeStatusColor(group: DuplicateGroup): string {
    switch (group.changeStatus) {
      case 'new':
        return '#FF9500';
      case 'increased':
        return '#FF3B30';
      case 'decreased':
        return '#34C759';
      default:
        return '#8E8E93';
    }
  }

  build() {
    Column() {
      // === È°∂ÈÉ®Ê†áÈ¢òÂíåÊâ´Êèè‰ø°ÊÅØ ===
      Column() {
        Text('Êñá‰ª∂ÂéªÈáç')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .margin({ bottom: 8 })

        Row() {
          Text(`‰∏äÊ¨°Êâ´Êèè: ${this.lastScanTime}`)
            .fontSize(12)
            .fontColor('#8E8E93')
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })
      .alignItems(HorizontalAlign.Start)

      // === Êìç‰ΩúÊåâÈíÆÂå∫ ===
      Row({ space: 10 }) {
        Button(this.isScanning ? 'Êâ´Êèè‰∏≠...' : 'ÂÖ®ÈáèÊâ´Êèè')
          .onClick(() => this.performFullScan())
          .enabled(!this.isScanning)
          .height(40)
          .fontSize(14)
          .backgroundColor(this.isScanning ? '#C7C7CC' : '#007AFF')
          .fontColor(Color.White)
          .borderRadius(8)
          .layoutWeight(1)

        Button('Â¢ûÈáèÊâ´Êèè')
          .onClick(() => this.performIncrementalScan())
          .enabled(!this.isScanning && this.lastScanTime !== '‰ªéÊú™Êâ´Êèè')
          .height(40)
          .fontSize(14)
          .backgroundColor((!this.isScanning && this.lastScanTime !== '‰ªéÊú™Êâ´Êèè') ? '#34C759' : '#C7C7CC')
          .fontColor(Color.White)
          .borderRadius(8)
          .layoutWeight(1)

        Button('‰∏ÄÈîÆÂéªÈáç')
          .onClick(() => {
            if (this.scanResult && this.scanResult.duplicateGroups.length > 0) {
              this.confirmAction = 'dedup_all';
              this.showConfirmDialog = true;
            } else {
              this.showToast('ËØ∑ÂÖàÊâßË°åÊâ´Êèè', 'info');
            }
          })
          .enabled(!this.isScanning && this.scanResult !== null && this.scanResult.duplicateGroups.length > 0)
          .height(40)
          .fontSize(14)
          .backgroundColor(
            (!this.isScanning && this.scanResult !== null && this.scanResult.duplicateGroups.length > 0)
              ? '#FF3B30' : '#C7C7CC'
          )
          .fontColor(Color.White)
          .borderRadius(8)
          .layoutWeight(1)
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 12 })

      // === Ê∂àÊÅØÊèêÁ§∫ ===
      if (this.showMessage) {
        Text(this.messageText)
          .fontSize(14)
          .fontColor('#FFFFFF')
          .backgroundColor(
            this.messageType === 'success' ? '#34C759' :
              (this.messageType === 'error' ? '#FF3B30' : '#007AFF')
          )
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .borderRadius(8)
          .margin({ left: 16, right: 16, bottom: 8 })
      }

      // === Êâ´ÊèèÁªìÊûúÁªüËÆ° ===
      if (this.scanResult) {
        Row() {
          Column() {
            Text(`${this.scanResult.scannedFiles}`)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#007AFF')
            Text('Êâ´ÊèèÊñá‰ª∂')
              .fontSize(11)
              .fontColor('#8E8E93')
          }
          .layoutWeight(1)

          Column() {
            Text(`${this.scanResult.duplicateGroups.length}`)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FF9500')
            Text('ÈáçÂ§çÁªÑ')
              .fontSize(11)
              .fontColor('#8E8E93')
          }
          .layoutWeight(1)

          Column() {
            Text(`${this.scanResult.totalDuplicates}`)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FF3B30')
            Text('ÈáçÂ§çÊñá‰ª∂')
              .fontSize(11)
              .fontColor('#8E8E93')
          }
          .layoutWeight(1)

          Column() {
            Text(this.scanResult.totalWasteSizeReadable)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#34C759')
            Text('ÂèØËäÇÁúÅ')
              .fontSize(11)
              .fontColor('#8E8E93')
          }
          .layoutWeight(1)
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 8, bottom: 12 })
        .backgroundColor('#F8F8F8')
        .borderRadius(12)
        .margin({ left: 16, right: 16, bottom: 12 })
      }

      // === ÈáçÂ§çÊñá‰ª∂ÂàóË°® ===
      if (!this.scanResult) {
        Column() {
          Text('üîç')
            .fontSize(48)
            .margin({ bottom: 16 })
          Text('ÁÇπÂáª"ÂÖ®ÈáèÊâ´Êèè"ÂºÄÂßãÊ£ÄÊµãÈáçÂ§çÊñá‰ª∂')
            .fontSize(14)
            .fontColor('#8E8E93')
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else if (this.scanResult.duplicateGroups.length === 0) {
        Column() {
          Text('‚úÖ')
            .fontSize(48)
            .margin({ bottom: 16 })
          Text('Â§™Ê£í‰∫ÜÔºÅÊ≤°ÊúâÂèëÁé∞ÈáçÂ§çÊñá‰ª∂')
            .fontSize(14)
            .fontColor('#8E8E93')
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else {
        // Â¢ûÈáèÊâ´ÊèèÊèêÁ§∫
        if (this.scanResult.isIncremental && this.scanResult.changedFiles > 0) {
          Row() {
            Text(`üìä Êú¨Ê¨°‰ªÖÊâ´ÊèèÂèòÊõ¥Êñá‰ª∂ÔºåÂÖ± ${this.scanResult.changedFiles} ‰∏™Êñá‰ª∂ÊúâÂèòÂåñ`)
              .fontSize(12)
              .fontColor('#FF9500')
          }
          .width('100%')
          .padding({ left: 16, right: 16, bottom: 8 })
        }

        List({ space: 8 }) {
          ForEach(this.scanResult.duplicateGroups, (group: DuplicateGroup, index: number) => {
            ListItem() {
              Column() {
                // ÁªÑÊ†áÈ¢òË°å
                Row() {
                  Column() {
                    Row() {
                      Text(`ÈáçÂ§çÁªÑ ${index + 1}`)
                        .fontSize(16)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#333333')

                      if (group.changeStatus) {
                        Text(this.getChangeStatusText(group))
                          .fontSize(11)
                          .fontColor(Color.White)
                          .backgroundColor(this.getChangeStatusColor(group))
                          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                          .borderRadius(4)
                          .margin({ left: 8 })
                      }
                    }

                    Text(`${group.files.length} ‰∏™ÈáçÂ§çÊñá‰ª∂ ¬∑ ÂèØËäÇÁúÅ ${this.formatFileSize(group.wasteSize)}`)
                      .fontSize(12)
                      .fontColor('#8E8E93')
                      .margin({ top: 4 })
                  }
                  .alignItems(HorizontalAlign.Start)
                  .layoutWeight(1)

                  Text(this.isGroupExpanded(group.hash) ? '‚ñº' : '‚ñ∂')
                    .fontSize(14)
                    .fontColor('#8E8E93')
                }
                .width('100%')
                .padding(12)
                .onClick(() => this.toggleGroup(group.hash))

                // Â±ïÂºÄÁöÑÊñá‰ª∂ÂàóË°®
                if (this.isGroupExpanded(group.hash)) {
                  Column({ space: 6 }) {
                    ForEach(group.files, (file: DuplicateFileInfo, fileIndex: number) => {
                      Row() {
                        Column() {
                          Row() {
                            if (fileIndex === 0) {
                              Text('‰øùÁïô')
                                .fontSize(10)
                                .fontColor(Color.White)
                                .backgroundColor('#34C759')
                                .padding({ left: 4, right: 4, top: 1, bottom: 1 })
                                .borderRadius(4)
                                .margin({ right: 6 })
                            }

                            if (file.isNew) {
                              Text('Êñ∞Â¢û')
                                .fontSize(10)
                                .fontColor(Color.White)
                                .backgroundColor('#FF9500')
                                .padding({ left: 4, right: 4, top: 1, bottom: 1 })
                                .borderRadius(4)
                                .margin({ right: 6 })
                            }

                            Text(file.filename)
                              .fontSize(14)
                              .fontColor('#333333')
                              .maxLines(1)
                              .textOverflow({ overflow: TextOverflow.Ellipsis })
                          }

                          Text(`${file.sizeReadable} ¬∑ ${file.mtimeFormatted}`)
                            .fontSize(11)
                            .fontColor('#8E8E93')
                            .margin({ top: 2 })
                        }
                        .alignItems(HorizontalAlign.Start)
                        .layoutWeight(1)

                        if (fileIndex !== 0) {
                          Button('‰øùÁïôÊ≠§Êñá‰ª∂')
                            .onClick(() => {
                              this.selectedGroupHash = group.hash;
                              this.selectedKeepFile = file.filename;
                              this.confirmAction = 'dedup_group';
                              this.showConfirmDialog = true;
                            })
                            .height(28)
                            .fontSize(11)
                            .backgroundColor('#007AFF')
                            .fontColor(Color.White)
                            .borderRadius(14)
                        }
                      }
                      .width('100%')
                      .padding({ left: 12, right: 12, top: 8, bottom: 8 })
                      .backgroundColor(fileIndex === 0 ? '#E8F5E9' : '#FFF8E1')
                      .borderRadius(8)
                    })

                    // Âø´ÈÄüÊìç‰ΩúÊåâÈíÆ
                    Row({ space: 10 }) {
                      Button('‰øùÁïôÁ¨¨‰∏Ä‰∏™ÔºåÂà†Èô§ÂÖ∂‰ªñ')
                        .onClick(() => {
                          this.selectedGroupHash = group.hash;
                          this.selectedKeepFile = group.files[0].filename;
                          this.confirmAction = 'dedup_group';
                          this.showConfirmDialog = true;
                        })
                        .height(36)
                        .fontSize(13)
                        .backgroundColor('#FF3B30')
                        .fontColor(Color.White)
                        .borderRadius(8)
                        .layoutWeight(1)
                    }
                    .width('100%')
                    .padding({ top: 8 })
                  }
                  .width('100%')
                  .padding({ left: 12, right: 12, bottom: 12 })
                }
              }
              .backgroundColor(Color.White)
              .borderRadius(12)
              .border({ width: 1, color: '#E0E0E0' })
            }
          })
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ left: 16, right: 16 })
      }

      // === Á°ÆËÆ§ÂØπËØùÊ°Ü ===
      if (this.showConfirmDialog) {
        Stack()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.5)')
          .onClick(() => {
            this.showConfirmDialog = false;
          })
          .position({ x: 0, y: 0 })

        Column() {
          Text(this.confirmAction === 'dedup_all' ? 'Á°ÆËÆ§‰∏ÄÈîÆÂéªÈáç' : 'Á°ÆËÆ§Âà†Èô§ÈáçÂ§çÊñá‰ª∂')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .margin({ bottom: 16 })

          Text(
            this.confirmAction === 'dedup_all'
              ? `Âç≥Â∞ÜÂà†Èô§ÊâÄÊúâÈáçÂ§çÁªÑ‰∏≠ÁöÑÂ§ö‰ΩôÊñá‰ª∂ÔºåÊØèÁªÑ‰øùÁïôÊúÄÊó©ÂàõÂª∫ÁöÑÊñá‰ª∂„ÄÇ\n\nÂÖ± ${this.scanResult ? this.scanResult.duplicateGroups.length : 0} ÁªÑÈáçÂ§çÊñá‰ª∂Â∞ÜË¢´Â§ÑÁêÜ„ÄÇ\n\nÂà†Èô§ÁöÑÊñá‰ª∂Â∞ÜÁßªÂÖ•ÂõûÊî∂Á´ôÔºåÂèØ‰ª•ÊÅ¢Â§ç„ÄÇ`
              : `Âç≥Â∞ÜÂà†Èô§ËØ•ÁªÑ‰∏≠Èô§ "${this.selectedKeepFile}" ‰ª•Â§ñÁöÑÊâÄÊúâÊñá‰ª∂„ÄÇ\n\nÂà†Èô§ÁöÑÊñá‰ª∂Â∞ÜÁßªÂÖ•ÂõûÊî∂Á´ôÔºåÂèØ‰ª•ÊÅ¢Â§ç„ÄÇ`
          )
            .fontSize(14)
            .fontColor('#666666')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 24 })

          Row({ space: 16 }) {
            Button('ÂèñÊ∂à')
              .onClick(() => {
                this.showConfirmDialog = false;
              })
              .height(44)
              .fontSize(16)
              .backgroundColor('#E0E0E0')
              .fontColor('#333333')
              .borderRadius(8)
              .layoutWeight(1)

            Button('Á°ÆËÆ§Âà†Èô§')
              .onClick(() => {
                if (this.confirmAction === 'dedup_all') {
                  this.performDeduplicateAll();
                } else {
                  this.performDeduplicateGroup();
                }
              })
              .height(44)
              .fontSize(16)
              .backgroundColor('#FF3B30')
              .fontColor(Color.White)
              .borderRadius(8)
              .layoutWeight(1)
          }
          .width('100%')
        }
        .width('85%')
        .padding(24)
        .backgroundColor(Color.White)
        .borderRadius(16)
        .position({ x: '7.5%', y: '30%' })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  // Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
  private formatFileSize(bytes: number): string {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))} ${sizes[i]}`;
  }
}
