/*
 * æ–‡ä»¶åŽ»é‡é¡µé¢ç»„ä»¶ - å®Œæ•´ç‰ˆï¼ˆæ”¯æŒå›žæ»šå’Œå¢žé‡æ‰«æï¼‰
 */

import { DeduplicationManager, DuplicateGroup, FileItem, ImportDirectoryResult, IncrementalScanResult, TrashItem } from '../common/utils/DeduplicationManager';
import { picker } from '@kit.CoreFileKit';

// åŽ»é‡ç»Ÿè®¡ä¿¡æ¯æŽ¥å£
interface DeduplicateStats {
  keep: number;
  deleteCount: number;
  saveSpace: number;
}

@Component
export struct DeduplicationTab {
  // åŽ»é‡ç®¡ç†å™¨
  @State deduplicationManager: DeduplicationManager | null = null;

  // æ‰«æçŠ¶æ€
  @State isScanning: boolean = false;
  @State hasScanned: boolean = false;
  @State refreshKey: number = 0; // å¼ºåˆ¶åˆ·æ–°

  // æ‰«æç»“æžœ
  @State totalFilesCount: number = 0;
  @State duplicateGroupsCount: number = 0;
  @State savableSpaceText: string = '0 B';
  @State duplicateGroups: DuplicateGroup[] = [];

  // å¢žé‡æ‰«æä¿¡æ¯
  @State lastScanTimeText: string = 'ä»Žæœªæ‰«æ';
  @State isIncrementalScan: boolean = false;
  @State scannedFilesCount: number = 0;
  @State newDuplicateGroupsCount: number = 0;

  // å›žæ”¶ç«™
  @State showTrashPanel: boolean = false;
  @State trashItems: TrashItem[] = [];

  // æ–‡ä»¶å¯¼å…¥
  @State isImporting: boolean = false;

  // æ¶ˆæ¯æç¤º
  @State showMessage: boolean = false;
  @State messageText: string = '';
  @State messageType: 'success' | 'error' | 'info' = 'info';

  // ç¡®è®¤å¯¹è¯æ¡†
  @State showConfirmDialog: boolean = false;
  @State confirmAction: 'deduplicate' | 'delete' | 'clearTrash' = 'deduplicate';
  @State pendingDeleteFile: FileItem | null = null;
  @State pendingTrashItem: TrashItem | null = null;

  aboutToAppear() {
    let context = this.getUIContext().getHostContext() as Context;
    this.deduplicationManager = new DeduplicationManager(context);
    this.updateLastScanTime();
    this.loadTrashItems();
  }

  private updateLastScanTime() {
    if (this.deduplicationManager) {
      this.lastScanTimeText = this.deduplicationManager.getLastScanTimeReadable();
    }
  }

  private loadTrashItems() {
    if (this.deduplicationManager) {
      this.trashItems = [...this.deduplicationManager.getTrashItems()];
    }
  }

  // å¼€å§‹æ‰«æ
  private async startScan(incremental: boolean = false) {
    if (!this.deduplicationManager) {
      this.showToast('åˆå§‹åŒ–å¤±è´¥', 'error');
      return;
    }

    this.isScanning = true;
    this.hasScanned = false;

    // é‡ç½®çŠ¶æ€ï¼ˆä»…å…¨é‡æ‰«æï¼‰
    if (!incremental) {
      this.totalFilesCount = 0;
      this.duplicateGroupsCount = 0;
      this.savableSpaceText = '0 B';
      this.duplicateGroups = [];
      this.deduplicationManager.clearResults();
    }

    try {
      const result = await this.deduplicationManager.scanFilesDir(incremental);

      // æ›´æ–°çŠ¶æ€å˜é‡
      this.totalFilesCount = result.totalFiles;
      this.duplicateGroupsCount = result.duplicateGroups;
      this.savableSpaceText = result.savableSpaceReadable;
      this.isIncrementalScan = result.isIncremental;
      this.scannedFilesCount = result.scannedFiles;
      this.newDuplicateGroupsCount = result.newDuplicateGroups;

      // èŽ·å–é‡å¤ç»„æ•°ç»„
      const groups = this.deduplicationManager.getDuplicateGroups();
      this.duplicateGroups = [...groups];

      this.hasScanned = true;
      this.updateLastScanTime();

      if (result.duplicateGroups === 0) {
        this.showToast('æœªå‘çŽ°é‡å¤æ–‡ä»¶', 'info');
      } else if (incremental && result.scannedFiles === 0) {
        this.showToast('æ²¡æœ‰å˜æ›´æ–‡ä»¶', 'info');
      } else if (incremental) {
        this.showToast(`å¢žé‡æ‰«æå®Œæˆï¼Œæ–°å¢ž ${result.newDuplicateGroups} ç»„é‡å¤`, 'success');
      } else {
        this.showToast(`å‘çŽ° ${result.duplicateGroups} ç»„é‡å¤æ–‡ä»¶`, 'success');
      }
    } catch (error) {
      console.error('æ‰«æå¤±è´¥:', error);
      this.showToast('æ‰«æå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    } finally {
      this.isScanning = false;
    }
  }

  // åˆ‡æ¢ç»„å±•å¼€çŠ¶æ€
  private toggleGroupExpanded(group: DuplicateGroup) {
    group.expanded = !group.expanded;
    this.duplicateGroups = [...this.duplicateGroups];
  }

  // åˆ‡æ¢æ–‡ä»¶é€‰ä¸­çŠ¶æ€
  private toggleFileSelection(group: DuplicateGroup, file: FileItem) {
    file.selected = !file.selected;
    if (!file.selected) {
      const selectedCount = group.files.filter(item => item.selected).length;
      if (selectedCount === 0) {
        file.selected = true;
        this.showToast('æ¯ç»„è‡³å°‘ä¿ç•™ä¸€ä¸ªæ–‡ä»¶', 'info');
        return;
      }
    }
    this.duplicateGroups = [...this.duplicateGroups];
  }

  // ä¸€é”®åŽ»é‡å‡†å¤‡
  private prepareAutoDeduplicate() {
    if (!this.deduplicationManager || this.duplicateGroups.length === 0) return;
    this.deduplicationManager.autoSelectForDeduplicate();
    this.duplicateGroups = [...this.deduplicationManager.getDuplicateGroups()];
    this.confirmAction = 'deduplicate';
    this.showConfirmDialog = true;
  }

  // æ‰§è¡ŒåŽ»é‡
  private async executeDeduplicate() {
    if (!this.deduplicationManager) return;

    const deletedCount = this.deduplicationManager.executeDeduplicate();
    this.showConfirmDialog = false;

    if (deletedCount > 0) {
      this.showToast(`å·²ç§»åŠ¨ ${deletedCount} ä¸ªæ–‡ä»¶åˆ°å›žæ”¶ç«™`, 'success');
      this.loadTrashItems();
      await this.startScan(false);
    } else {
      this.showToast('æ²¡æœ‰æ–‡ä»¶è¢«åˆ é™¤', 'info');
    }
  }

  // æ‰‹åŠ¨åˆ é™¤å•ä¸ªæ–‡ä»¶
  private deleteOneFile(file: FileItem) {
    this.pendingDeleteFile = file;
    this.confirmAction = 'delete';
    this.showConfirmDialog = true;
  }

  // ç¡®è®¤åˆ é™¤å•ä¸ªæ–‡ä»¶
  private async confirmDeleteOneFile() {
    if (!this.deduplicationManager || !this.pendingDeleteFile) return;

    const success = this.deduplicationManager.deleteFile(this.pendingDeleteFile.path);
    this.showConfirmDialog = false;

    if (success) {
      this.showToast(`å·²ç§»åŠ¨åˆ°å›žæ”¶ç«™: ${this.pendingDeleteFile.filename}`, 'success');
      this.loadTrashItems();
      await this.startScan(false);
    } else {
      this.showToast('åˆ é™¤å¤±è´¥', 'error');
    }

    this.pendingDeleteFile = null;
  }

  // æ¢å¤æ–‡ä»¶
  private async restoreFile(item: TrashItem) {
    if (!this.deduplicationManager) return;

    const success = this.deduplicationManager.restoreFromTrash(item);
    if (success) {
      this.showToast(`å·²æ¢å¤: ${item.filename}`, 'success');
      this.loadTrashItems();
      await this.startScan(false);
    } else {
      this.showToast('æ¢å¤å¤±è´¥', 'error');
    }
  }

  // æ°¸ä¹…åˆ é™¤å•ä¸ª
  private permanentDeleteOne(item: TrashItem) {
    if (!this.deduplicationManager) return;

    const success = this.deduplicationManager.permanentDelete(item);
    if (success) {
      this.showToast(`å·²æ°¸ä¹…åˆ é™¤: ${item.filename}`, 'success');
      this.loadTrashItems();
    } else {
      this.showToast('åˆ é™¤å¤±è´¥', 'error');
    }
  }

  // æ¸…ç©ºå›žæ”¶ç«™
  private clearTrash() {
    if (!this.deduplicationManager) return;

    const count = this.deduplicationManager.clearTrash();
    this.showConfirmDialog = false;
    this.loadTrashItems();

    if (count > 0) {
      this.showToast(`å·²æ°¸ä¹…åˆ é™¤ ${count} ä¸ªæ–‡ä»¶`, 'success');
    }
  }

  // å¯¼å…¥æ–‡ä»¶
  private async importFiles() {
    if (!this.deduplicationManager) return;

    this.isImporting = true;

    try {
      const documentPicker = new picker.DocumentViewPicker();
      const selectOptions = new picker.DocumentSelectOptions();
      selectOptions.maxSelectNumber = 100;

      const uris = await documentPicker.select(selectOptions);

      if (uris && uris.length > 0) {
        let successCount = 0;
        for (const uri of uris) {
          const filename = uri.split('/').pop() || `file_${Date.now()}`;
          const success = await this.deduplicationManager.importFileToFilesDir(uri, filename);
          if (success) successCount++;
        }
        this.showToast(`æˆåŠŸå¯¼å…¥ ${successCount} ä¸ªæ–‡ä»¶`, 'success');
        // é‡æ–°æ‰«æ
        this.refreshKey++;
        await this.startScan(false);
      }
    } catch (error) {
      console.error('å¯¼å…¥æ–‡ä»¶å¤±è´¥:', error);
      this.showToast('å¯¼å…¥å¤±è´¥', 'error');
    } finally {
      this.isImporting = false;
    }
  }

  // å¯¼å…¥æ–‡ä»¶å¤¹
  private async importFolder() {
    if (!this.deduplicationManager) return;

    this.isImporting = true;

    try {
      const documentPicker = new picker.DocumentViewPicker();
      const selectOptions = new picker.DocumentSelectOptions();
      selectOptions.maxSelectNumber = 200;

      const uris = await documentPicker.select(selectOptions);
      if (uris && uris.length > 0) {
        let total: ImportDirectoryResult = { totalFiles: 0, importedFiles: 0, skippedFiles: 0 };
        let hasImport = false;

        for (const uri of uris) {
          const dirResult: ImportDirectoryResult | null = await this.deduplicationManager.importDirectoryToFilesDir(uri);
          if (dirResult) {
            total.totalFiles += dirResult.totalFiles;
            total.importedFiles += dirResult.importedFiles;
            total.skippedFiles += dirResult.skippedFiles;
            hasImport = true;
            continue;
          }

          const filename = uri.split('/').pop() || `file_${Date.now()}`;
          const success = await this.deduplicationManager.importFileToFilesDir(uri, filename);
          total.totalFiles += 1;
          if (success) total.importedFiles += 1;
          else total.skippedFiles += 1;
          hasImport = true;
        }

        if (!hasImport) {
          this.showToast('è¯·é€‰æ‹©æ–‡ä»¶å¤¹', 'info');
          return;
        }

        const summary = total.skippedFiles > 0 ? `ï¼Œå¤±è´¥ ${total.skippedFiles} ä¸ª` : '';
        this.showToast(`æˆåŠŸå¯¼å…¥ ${total.importedFiles}/${total.totalFiles} ä¸ªæ–‡ä»¶${summary}`, 'success');

        this.refreshKey++;
        await this.startScan(false);
      }
    } catch (error) {
      console.error('å¯¼å…¥æ–‡ä»¶å¤¹å¤±è´¥:', error);
      this.showToast('å¯¼å…¥å¤±è´¥', 'error');
    } finally {
      this.isImporting = false;
    }
  }

  // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
  private showToast(message: string, type: 'success' | 'error' | 'info') {
    this.messageText = message;
    this.messageType = type;
    this.showMessage = true;
    setTimeout(() => { this.showMessage = false; }, 3000);
  }

  private getMessageColor(): string {
    switch (this.messageType) {
      case 'success': return '#34C759';
      case 'error': return '#FF3B30';
      default: return '#007AFF';
    }
  }

  private getDeduplicateStats(): DeduplicateStats {
    let keep = 0, del = 0, saveSpace = 0;
    for (const group of this.duplicateGroups) {
      for (const file of group.files) {
        if (file.selected) keep++;
        else { del++; saveSpace += file.size; }
      }
    }
    return { keep, deleteCount: del, saveSpace };
  }

  private formatFileSize(bytes: number): string {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))} ${sizes[i]}`;
  }

  build() {
    Stack() {
      Column() {
        // æ ‡é¢˜æ 
        Row() {
          Text('ðŸ“ æ–‡ä»¶åŽ»é‡')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .layoutWeight(1)

          // å›žæ”¶ç«™æŒ‰é’®
          Button('ðŸ—‘ï¸ å›žæ”¶ç«™' + (this.trashItems.length > 0 ? ` (${this.trashItems.length})` : ''))
            .height(32)
            .fontSize(12)
            .fontColor(this.trashItems.length > 0 ? '#FF9500' : '#666666')
            .backgroundColor('#F0F0F0')
            .borderRadius(16)
            .onClick(() => {
              this.loadTrashItems();
              this.showTrashPanel = true;
            })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 8 })

        // æ¶ˆæ¯æç¤º
        if (this.showMessage) {
          Text(this.messageText)
            .fontSize(14)
            .fontColor('#FFFFFF')
            .backgroundColor(this.getMessageColor())
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .borderRadius(8)
            .margin({ left: 16, right: 16, bottom: 8 })
        }

        Scroll() {
          Column() {
            // æ‰«ææ“ä½œåŒºåŸŸ
            Column() {
              Row() {
                Text('ä¸Šæ¬¡æ‰«æ: ')
                  .fontSize(13)
                  .fontColor('#999999')
                Text(this.lastScanTimeText)
                  .fontSize(13)
                  .fontColor('#666666')
              }
              .width('100%')
              .margin({ bottom: 12 })

              Row() {
                Button(this.isScanning ? 'æ‰«æä¸­...' : 'å…¨é‡æ‰«æ')
                  .layoutWeight(1)
                  .height(44)
                  .fontSize(15)
                  .fontColor('#FFFFFF')
                  .backgroundColor(this.isScanning ? '#999999' : '#007AFF')
                  .borderRadius(10)
                  .enabled(!this.isScanning)
                  .onClick(() => { this.startScan(false); })

                Button('å¢žé‡æ‰«æ')
                  .layoutWeight(1)
                  .height(44)
                  .fontSize(15)
                  .fontColor('#FFFFFF')
                  .backgroundColor(this.isScanning ? '#999999' : '#34C759')
                  .borderRadius(10)
                  .enabled(!this.isScanning && this.deduplicationManager?.getLastScanTime() !== 0)
                  .margin({ left: 12 })
                  .onClick(() => { this.startScan(true); })
              }
              .width('100%')

              // å¯¼å…¥æ–‡ä»¶æŒ‰é’®
              Button(this.isImporting ? 'å¯¼å…¥ä¸­...' : 'ðŸ“¥ å¯¼å…¥æœ¬åœ°æ–‡ä»¶')
                .width('100%')
                .height(40)
                .fontSize(14)
                .fontColor('#007AFF')
                .backgroundColor('#E8F4FF')
                .borderRadius(10)
                .margin({ top: 12 })
                .enabled(!this.isImporting && !this.isScanning)
                .onClick(() => { this.importFiles(); })

              Button(this.isImporting ? 'å¯¼å…¥ä¸­...' : 'ðŸ“‚ å¯¼å…¥æœ¬åœ°æ–‡ä»¶å¤¹')
                .width('100%')
                .height(40)
                .fontSize(14)
                .fontColor('#FF9500')
                .backgroundColor('#FFF4E5')
                .borderRadius(10)
                .margin({ top: 8 })
                .enabled(!this.isImporting && !this.isScanning)
                .onClick(() => { this.importFolder(); })

              if (this.isIncrementalScan && this.hasScanned) {
                Text(`ðŸ“Š æœ¬æ¬¡ä»…æ‰«æå˜æ›´æ–‡ä»¶ (${this.scannedFilesCount} ä¸ª)ï¼Œæ–°å¢žé‡å¤ ${this.newDuplicateGroupsCount} ç»„`)
                  .fontSize(12)
                  .fontColor('#34C759')
                  .margin({ top: 10 })
              }
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .margin({ left: 12, right: 12, top: 8, bottom: 8 })

            // æ‰«æç»“æžœç»Ÿè®¡
            if (this.hasScanned) {
              Column() {
                Text('æ‰«æç»“æžœ')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')
                  .width('100%')
                  .margin({ bottom: 10 })

                Row() {
                  this.StatCard('æ€»æ–‡ä»¶', `${this.totalFilesCount}`, '#007AFF')
                  this.StatCard('é‡å¤ç»„', `${this.duplicateGroupsCount}`, '#FF9500')
                  this.StatCard('å¯èŠ‚çœ', this.savableSpaceText, '#34C759')
                }
                .width('100%')
                .justifyContent(FlexAlign.SpaceBetween)
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFFFF')
              .borderRadius(12)
              .margin({ left: 12, right: 12, bottom: 8 })
            }

            // é‡å¤æ–‡ä»¶ç»„åˆ—è¡¨
            if (this.hasScanned && this.duplicateGroups.length > 0) {
              Column() {
                Row() {
                  Text('é‡å¤æ–‡ä»¶ç»„')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#333333')
                    .layoutWeight(1)

                  Button('ä¸€é”®åŽ»é‡')
                    .height(32)
                    .fontSize(13)
                    .fontColor('#FFFFFF')
                    .backgroundColor('#FF3B30')
                    .borderRadius(16)
                    .onClick(() => { this.prepareAutoDeduplicate(); })
                }
                .width('100%')
                .margin({ bottom: 12 })

                ForEach(this.duplicateGroups, (group: DuplicateGroup) => {
                  Column() {
                    Row() {
                      Text(group.expanded ? 'â–¼' : 'â–¶')
                        .fontSize(14)
                        .fontColor('#666666')
                        .margin({ right: 8 })

                      Column() {
                        Row() {
                          Text(`${group.files.length} ä¸ªç›¸åŒæ–‡ä»¶`)
                            .fontSize(14)
                            .fontWeight(FontWeight.Medium)
                            .fontColor('#333333')
                          Text(`(${group.sizeReadable})`)
                            .fontSize(12)
                            .fontColor('#999999')
                            .margin({ left: 8 })
                        }
                        Text(`å“ˆå¸Œ: ${group.hash.substring(0, 16)}...`)
                          .fontSize(11)
                          .fontColor('#AAAAAA')
                      }
                      .alignItems(HorizontalAlign.Start)
                      .layoutWeight(1)
                    }
                    .width('100%')
                    .padding(12)
                    .onClick(() => { this.toggleGroupExpanded(group); })

                    if (group.expanded) {
                      Column() {
                        ForEach(group.files, (file: FileItem) => {
                          Row() {
                            Checkbox()
                              .select(file.selected)
                              .onChange(() => { this.toggleFileSelection(group, file); })
                              .margin({ right: 10 })

                            Column() {
                              Text(file.filename)
                                .fontSize(13)
                                .fontWeight(FontWeight.Medium)
                                .fontColor(file.selected ? '#007AFF' : '#333333')
                                .maxLines(1)
                                .textOverflow({ overflow: TextOverflow.Ellipsis })
                              Text(file.path)
                                .fontSize(10)
                                .fontColor('#999999')
                                .maxLines(1)
                                .textOverflow({ overflow: TextOverflow.Ellipsis })
                            }
                            .alignItems(HorizontalAlign.Start)
                            .layoutWeight(1)

                            if (file.selected) {
                              Text('ä¿ç•™')
                                .fontSize(11)
                                .fontColor('#FFFFFF')
                                .backgroundColor('#34C759')
                                .padding({ left: 8, right: 8, top: 3, bottom: 3 })
                                .borderRadius(10)
                            } else {
                              Button('åˆ é™¤')
                                .height(26)
                                .fontSize(11)
                                .fontColor('#FFFFFF')
                                .backgroundColor('#FF3B30')
                                .borderRadius(13)
                                .onClick(() => { this.deleteOneFile(file); })
                            }
                          }
                          .width('100%')
                          .padding({ left: 12, right: 12, top: 8, bottom: 8 })
                          .backgroundColor(file.selected ? '#F0F8FF' : '#FAFAFA')
                          .borderRadius(8)
                          .margin({ bottom: 4 })
                        })
                      }
                      .padding({ left: 12, right: 12, bottom: 12 })
                    }
                  }
                  .width('100%')
                  .backgroundColor('#FFFAF0')
                  .border({ width: 1, color: '#FF9500', radius: 10 })
                  .margin({ bottom: 10 })
                })
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FFFFFF')
              .borderRadius(12)
              .margin({ left: 12, right: 12, bottom: 100 })
            }

            // æ— é‡å¤æ–‡ä»¶æç¤º
            if (this.hasScanned && this.duplicateGroups.length === 0) {
              Column() {
                Text('âœ…').fontSize(48).margin({ bottom: 12 })
                Text('å¤ªæ£’äº†ï¼æ²¡æœ‰å‘çŽ°é‡å¤æ–‡ä»¶')
                  .fontSize(16)
                  .fontColor('#34C759')
                  .fontWeight(FontWeight.Medium)
              }
              .width('100%')
              .padding(40)
              .backgroundColor('#FFFFFF')
              .borderRadius(12)
              .margin({ left: 12, right: 12, bottom: 8 })
            }
          }
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')

      // å›žæ”¶ç«™é¢æ¿
      if (this.showTrashPanel) {
        Stack() {
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.5)')
            .onClick(() => { this.showTrashPanel = false; })

          Column() {
            Row() {
              Text('ðŸ—‘ï¸ å›žæ”¶ç«™')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333333')
                .layoutWeight(1)

              if (this.trashItems.length > 0) {
                Button('æ¸…ç©º')
                  .height(28)
                  .fontSize(12)
                  .fontColor('#FF3B30')
                  .backgroundColor('#FFF0F0')
                  .borderRadius(14)
                  .onClick(() => {
                    this.confirmAction = 'clearTrash';
                    this.showConfirmDialog = true;
                  })
              }

              Text('âœ•')
                .fontSize(20)
                .fontColor('#999999')
                .margin({ left: 12 })
                .onClick(() => { this.showTrashPanel = false; })
            }
            .width('100%')
            .padding(16)

            if (this.trashItems.length === 0) {
              Column() {
                Text('ðŸ“­').fontSize(48).margin({ bottom: 12 })
                Text('å›žæ”¶ç«™ä¸ºç©º').fontSize(14).fontColor('#999999')
              }
              .width('100%')
              .padding(40)
            } else {
              Scroll() {
                Column() {
                  ForEach(this.trashItems, (item: TrashItem) => {
                    Row() {
                      Column() {
                        Text(item.filename)
                          .fontSize(14)
                          .fontColor('#333333')
                          .maxLines(1)
                          .textOverflow({ overflow: TextOverflow.Ellipsis })
                        Text(`${item.sizeReadable} Â· åˆ é™¤äºŽ ${item.deleteTimeReadable}`)
                          .fontSize(11)
                          .fontColor('#999999')
                      }
                      .alignItems(HorizontalAlign.Start)
                      .layoutWeight(1)

                      Button('æ¢å¤')
                        .height(28)
                        .fontSize(12)
                        .fontColor('#34C759')
                        .backgroundColor('#F0FFF0')
                        .borderRadius(14)
                        .onClick(() => { this.restoreFile(item); })

                      Button('åˆ é™¤')
                        .height(28)
                        .fontSize(12)
                        .fontColor('#FF3B30')
                        .backgroundColor('#FFF0F0')
                        .borderRadius(14)
                        .margin({ left: 8 })
                        .onClick(() => { this.permanentDeleteOne(item); })
                    }
                    .width('100%')
                    .padding(12)
                    .backgroundColor('#FAFAFA')
                    .borderRadius(8)
                    .margin({ bottom: 8, left: 16, right: 16 })
                  })
                }
              }
              .layoutWeight(1)
            }
          }
          .width('90%')
          .height('70%')
          .backgroundColor('#FFFFFF')
          .borderRadius(16)
        }
        .width('100%')
        .height('100%')
      }

      // ç¡®è®¤å¯¹è¯æ¡†
      if (this.showConfirmDialog) {
        Stack() {
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0,0,0,0.5)')
            .onClick(() => { this.showConfirmDialog = false; })

          Column() {
            Text(this.confirmAction === 'deduplicate' ? 'ç¡®è®¤ä¸€é”®åŽ»é‡' :
                 this.confirmAction === 'clearTrash' ? 'ç¡®è®¤æ¸…ç©ºå›žæ”¶ç«™' : 'ç¡®è®¤åˆ é™¤')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .margin({ bottom: 16 })

            if (this.confirmAction === 'deduplicate') {
              Column() {
                Text(`å°†ç§»åŠ¨ ${this.getDeduplicateStats().deleteCount} ä¸ªé‡å¤æ–‡ä»¶åˆ°å›žæ”¶ç«™`)
                  .fontSize(14).fontColor('#666666')
                Text(`ä¿ç•™ ${this.getDeduplicateStats().keep} ä¸ªæ–‡ä»¶`)
                  .fontSize(14).fontColor('#666666')
                Text(`å¯èŠ‚çœç©ºé—´: ${this.formatFileSize(this.getDeduplicateStats().saveSpace)}`)
                  .fontSize(14).fontColor('#34C759').margin({ top: 8 })
              }.margin({ bottom: 20 })
            } else if (this.confirmAction === 'clearTrash') {
              Text(`å°†æ°¸ä¹…åˆ é™¤å›žæ”¶ç«™ä¸­çš„ ${this.trashItems.length} ä¸ªæ–‡ä»¶`)
                .fontSize(14).fontColor('#666666').margin({ bottom: 20 })
            } else if (this.pendingDeleteFile) {
              Text(`ç¡®å®šåˆ é™¤ "${this.pendingDeleteFile.filename}" å—ï¼Ÿ`)
                .fontSize(14).fontColor('#666666').margin({ bottom: 20 })
            }

            Text(this.confirmAction === 'clearTrash' ? 'âš ï¸ æ­¤æ“ä½œä¸å¯æ¢å¤ï¼' : 'ðŸ’¡ å¯åœ¨å›žæ”¶ç«™ä¸­æ¢å¤')
              .fontSize(13)
              .fontColor(this.confirmAction === 'clearTrash' ? '#FF3B30' : '#999999')
              .margin({ bottom: 20 })

            Row() {
              Button('å–æ¶ˆ')
                .width('45%')
                .height(44)
                .fontSize(15)
                .fontColor('#333333')
                .backgroundColor('#E5E5E5')
                .borderRadius(10)
                .onClick(() => { this.showConfirmDialog = false; this.pendingDeleteFile = null; })

              Button('ç¡®è®¤')
                .width('45%')
                .height(44)
                .fontSize(15)
                .fontColor('#FFFFFF')
                .backgroundColor('#FF3B30')
                .borderRadius(10)
                .onClick(async () => {
                  if (this.confirmAction === 'deduplicate') await this.executeDeduplicate();
                  else if (this.confirmAction === 'clearTrash') this.clearTrash();
                  else await this.confirmDeleteOneFile();
                })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
          }
          .width('85%')
          .padding(24)
          .backgroundColor('#FFFFFF')
          .borderRadius(16)
        }
        .width('100%')
        .height('100%')
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  StatCard(label: string, value: string, color: string) {
    Column() {
      Text(value).fontSize(18).fontWeight(FontWeight.Bold).fontColor(color)
      Text(label).fontSize(12).fontColor('#999999').margin({ top: 4 })
    }
    .padding({ top: 12, bottom: 12, left: 16, right: 16 })
    .backgroundColor('#F8F8F8')
    .borderRadius(10)
    .width('30%')
  }
}
