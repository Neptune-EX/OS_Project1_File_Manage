/*
 * æ–‡ä»¶å»é‡Tabé¡µé¢ - å®ç°é‡å¤æ–‡ä»¶æ‰«æã€å±•ç¤ºå’Œå»é‡åŠŸèƒ½
 *
 * æ”¯æŒä¸¤ç§æ‰«ææ¨¡å¼ï¼š
 * 1. Workerå¤šçº¿ç¨‹æ‰«æï¼ˆé»˜è®¤ï¼‰- åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä¸é˜»å¡UI
 * 2. ä¸»çº¿ç¨‹å¼‚æ­¥æ‰«æ - åœ¨ä¸»çº¿ç¨‹ä¸­åˆ†æ‰¹æ‰§è¡Œ
 */

import { DuplicateScanner, DuplicateGroup, DuplicateFileInfo, ScanResult, ScanCallbacks } from '../common/utils/DuplicateScanner';
import { fileIo } from '@kit.CoreFileKit';
import { common } from '@kit.AbilityKit';

// åŠ¨æ€ç»Ÿè®¡æ•°æ®æ¥å£
interface DynamicStats {
  scannedFiles: number;
  duplicateGroups: number;
  totalDuplicates: number;
  totalWasteSize: number;
  totalWasteSizeReadable: string;
}

@Component
export struct DeduplicationTab {
  @State scanResult: ScanResult | null = null;
  @State isScanning: boolean = false;
  @State expandedGroups: string[] = [];
  @State showMessage: boolean = false;
  @State messageText: string = '';
  @State messageType: string = 'success'; // 'success' | 'error' | 'info'
  @State lastScanTime: string = '';
  @State showConfirmDialog: boolean = false;
  @State confirmAction: string = ''; // 'dedup_all' | 'dedup_group'
  @State selectedGroupHash: string = '';
  @State selectedKeepFile: string = '';

  // å¯è§†åŒ–ç›¸å…³çŠ¶æ€
  @State scanProgress: number = 0;  // æ‰«æè¿›åº¦ 0-100
  @State scanProgressText: string = '';  // è¿›åº¦æ–‡æœ¬ "å½“å‰/æ€»æ•°"
  @State isRealTimeScanning: boolean = false;  // æ˜¯å¦æ­£åœ¨å®æ—¶æ‰«æ
  @State dynamicGroups: DuplicateGroup[] = [];  // åŠ¨æ€æ›´æ–°çš„é‡å¤ç»„åˆ—è¡¨
  @State dynamicStats: DynamicStats = {
    scannedFiles: 0,
    duplicateGroups: 0,
    totalDuplicates: 0,
    totalWasteSize: 0,
    totalWasteSizeReadable: '0 B'
  };
  @State displayGroups: DuplicateGroup[] = [];  // å½“å‰æ˜¾ç¤ºçš„é‡å¤ç»„åˆ—è¡¨

  // Workerå¤šçº¿ç¨‹æ‰«æå¼€å…³
  @State useWorkerScan: boolean = true;  // é»˜è®¤ä½¿ç”¨Workerå¤šçº¿ç¨‹æ‰«æ
  @State scanModeText: string = 'Workerå¤šçº¿ç¨‹';  // å½“å‰æ‰«ææ¨¡å¼æ–‡æœ¬

  // æŸ¥çœ‹æ–‡ä»¶å†…å®¹ç›¸å…³çŠ¶æ€
  @State showFileContentDialog: boolean = false;
  @State viewingFileName: string = '';
  @State viewingFileContent: string = '';

  private scanner: DuplicateScanner | null = null;
  private filesDir: string = '';

  aboutToAppear() {
    const context = this.getUIContext().getHostContext() as Context;
    this.scanner = DuplicateScanner.getInstance(context);
    this.lastScanTime = this.scanner.getLastScanTimeFormatted();

    // è·å–æ–‡ä»¶ç›®å½•è·¯å¾„
    const uiAbilityContext = context as common.UIAbilityContext;
    this.filesDir = uiAbilityContext.filesDir;
  }

  // æŸ¥çœ‹æ–‡ä»¶å†…å®¹
  private viewFileContent(filename: string) {
    try {
      const filePath = `${this.filesDir}/${filename}`;
      const file = fileIo.openSync(filePath, fileIo.OpenMode.READ_ONLY);
      const stat = fileIo.statSync(filePath);

      // é™åˆ¶è¯»å–å¤§å°ï¼Œé¿å…å†…å­˜é—®é¢˜
      const maxReadSize = 10 * 1024; // æœ€å¤šè¯»å–10KB
      const readSize = Math.min(stat.size, maxReadSize);
      const buffer = new ArrayBuffer(readSize);
      fileIo.readSync(file.fd, buffer);
      fileIo.closeSync(file);

      // è½¬æ¢ä¸ºå­—ç¬¦ä¸²
      const uint8Array = new Uint8Array(buffer);
      let content = '';
      for (let i = 0; i < uint8Array.length; i++) {
        content += String.fromCharCode(uint8Array[i]);
      }

      // å¦‚æœæ–‡ä»¶è¢«æˆªæ–­ï¼Œæ·»åŠ æç¤º
      if (stat.size > maxReadSize) {
        content += `\n\n... (æ–‡ä»¶è¿‡å¤§ï¼Œä»…æ˜¾ç¤ºå‰ ${maxReadSize} å­—èŠ‚)`;
      }

      this.viewingFileName = filename;
      this.viewingFileContent = content;
      this.showFileContentDialog = true;
    } catch (error) {
      this.showToast(`è¯»å–æ–‡ä»¶å¤±è´¥: ${error}`, 'error');
    }
  }

  // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
  private showToast(message: string, type: string = 'success') {
    this.messageText = message;
    this.messageType = type;
    this.showMessage = true;
    setTimeout(() => {
      this.showMessage = false;
    }, 3000);
  }

  // æ‰§è¡Œå…¨é‡æ‰«æ
  private async performFullScan() {
    if (!this.scanner || this.isScanning) return;

    this.isScanning = true;
    this.isRealTimeScanning = true;
    this.scanProgress = 0;
    this.scanProgressText = '';
    this.dynamicGroups = [];
    this.displayGroups = [];  // æ¸…ç©ºæ˜¾ç¤ºåˆ—è¡¨

    // æ ¹æ®æ‰«ææ¨¡å¼æ˜¾ç¤ºä¸åŒæç¤º
    const modeHint = this.useWorkerScan ? 'ï¼ˆWorkerå¤šçº¿ç¨‹æ¨¡å¼ï¼‰' : 'ï¼ˆä¸»çº¿ç¨‹å¼‚æ­¥æ¨¡å¼ï¼‰';
    this.showToast(`æ­£åœ¨æ‰«ææ–‡ä»¶...${modeHint}`, 'info');

    try {
      if (this.scanner) {
        // åˆ›å»ºå›è°ƒå¯¹è±¡
        const callbacks: ScanCallbacks = {
          onProgress: (current: number, total: number) => {
            this.scanProgress = Math.floor((current / total) * 100);
            this.scanProgressText = `${current}/${total}`;
          },
          onGroupFound: (group: DuplicateGroup) => {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ç»„ï¼ˆæ›´æ–°ï¼‰
            const existingIndex = this.dynamicGroups.findIndex((g: DuplicateGroup) => g.hash === group.hash);
            if (existingIndex >= 0) {
              // æ›´æ–°å·²å­˜åœ¨çš„ç»„
              this.dynamicGroups[existingIndex] = group;
              this.dynamicGroups = this.dynamicGroups.slice().sort((a, b) => b.wasteSize - a.wasteSize);
            } else {
              // æ’å…¥æ–°ç»„å¹¶æŒ‰ wasteSize é™åºæ’åº
              this.dynamicGroups = [...this.dynamicGroups, group]
                .sort((a, b) => b.wasteSize - a.wasteSize);
            }

            // æ›´æ–°æ˜¾ç¤ºåˆ—è¡¨
            this.displayGroups = this.dynamicGroups;

            // æ›´æ–°åŠ¨æ€ç»Ÿè®¡
            this.dynamicStats = {
              scannedFiles: this.scanProgressText.split('/')[0] ? parseInt(this.scanProgressText.split('/')[0]) : 0,
              duplicateGroups: this.dynamicGroups.length,
              totalDuplicates: this.dynamicGroups.reduce((sum, g) => sum + g.files.length, 0),
              totalWasteSize: this.dynamicGroups.reduce((sum, g) => sum + g.wasteSize, 0),
              totalWasteSizeReadable: this.formatFileSize(this.dynamicGroups.reduce((sum, g) => sum + g.wasteSize, 0))
            };
          }
        };

        // å®Œæˆå›è°ƒ
        const onComplete = (result: ScanResult) => {
          this.scanResult = result;
          this.lastScanTime = this.scanner!.getLastScanTimeFormatted();
          this.isScanning = false;
          this.isRealTimeScanning = false;

          // æ›´æ–°æ˜¾ç¤ºåˆ—è¡¨ä¸ºæœ€ç»ˆç»“æœ
          if (this.scanResult) {
            this.displayGroups = this.scanResult.duplicateGroups;
          }

          if (this.scanResult.duplicateGroups.length === 0) {
            this.showToast('æ‰«æå®Œæˆï¼Œæœªå‘ç°é‡å¤æ–‡ä»¶', 'info');
          } else {
            const modeInfo = this.useWorkerScan ? '[Worker]' : '[ä¸»çº¿ç¨‹]';
            this.showToast(
              `${modeInfo} æ‰«æå®Œæˆï¼å‘ç° ${this.scanResult.duplicateGroups.length} ç»„é‡å¤æ–‡ä»¶ï¼Œ` +
              `å¯èŠ‚çœ ${this.scanResult.totalWasteSizeReadable} ç©ºé—´`,
              'success'
            );
          }
        };

        // æ ¹æ®å¼€å…³é€‰æ‹©æ‰«ææ–¹å¼
        if (this.useWorkerScan) {
          // ä½¿ç”¨ Worker å¤šçº¿ç¨‹æ‰«æ
          this.scanner.fullScanWithWorker(callbacks, onComplete);
        } else {
          // ä½¿ç”¨ä¸»çº¿ç¨‹å¼‚æ­¥æ‰«æ
          this.scanner.fullScanAsync(callbacks, onComplete);
        }
      }
    } catch (error) {
      this.isScanning = false;
      this.isRealTimeScanning = false;
      this.showToast(`æ‰«æå¤±è´¥: ${error}`, 'error');
    }
  }

  // æ‰§è¡Œå¢é‡æ‰«æ
  private async performIncrementalScan() {
    if (!this.scanner || this.isScanning) return;

    this.isScanning = true;
    this.showToast('æ­£åœ¨æ‰§è¡Œå¢é‡æ‰«æ...', 'info');

    try {
      setTimeout(() => {
        if (this.scanner) {
          this.scanResult = this.scanner.incrementalScan();
          this.lastScanTime = this.scanner.getLastScanTimeFormatted();
          this.isScanning = false;

          // æ›´æ–°æ˜¾ç¤ºåˆ—è¡¨
          if (this.scanResult) {
            this.displayGroups = this.scanResult.duplicateGroups;
          }

          if (this.scanResult.changedFiles === 0) {
            this.showToast('å¢é‡æ‰«æå®Œæˆï¼Œæ–‡ä»¶æ— å˜åŒ–', 'info');
          } else {
            this.showToast(
              `å¢é‡æ‰«æå®Œæˆï¼æ£€æµ‹åˆ° ${this.scanResult.changedFiles} ä¸ªæ–‡ä»¶å˜æ›´`,
              'success'
            );
          }
        }
      }, 100);
    } catch (error) {
      this.isScanning = false;
      this.showToast(`æ‰«æå¤±è´¥: ${error}`, 'error');
    }
  }

  // ä¸€é”®å»é‡
  private performDeduplicateAll() {
    if (!this.scanner) return;

    const deletedCount = this.scanner.deduplicateAll();
    this.scanResult = this.scanner.fullScan();

    // æ›´æ–°æ˜¾ç¤ºåˆ—è¡¨
    if (this.scanResult) {
      this.displayGroups = this.scanResult.duplicateGroups;
    }

    this.showToast(`ä¸€é”®å»é‡å®Œæˆï¼å·²åˆ é™¤ ${deletedCount} ä¸ªé‡å¤æ–‡ä»¶`, 'success');
    this.showConfirmDialog = false;
  }

  // å¤„ç†å•ä¸ªé‡å¤ç»„
  private performDeduplicateGroup() {
    if (!this.scanner || !this.selectedGroupHash || !this.selectedKeepFile) return;

    const deletedCount = this.scanner.deduplicateGroup(this.selectedGroupHash, this.selectedKeepFile);
    this.scanResult = this.scanner.fullScan();

    // æ›´æ–°æ˜¾ç¤ºåˆ—è¡¨
    if (this.scanResult) {
      this.displayGroups = this.scanResult.duplicateGroups;
    }

    this.showToast(`å·²åˆ é™¤ ${deletedCount} ä¸ªé‡å¤æ–‡ä»¶ï¼Œä¿ç•™ "${this.selectedKeepFile}"`, 'success');
    this.showConfirmDialog = false;
    this.expandedGroups = this.expandedGroups.filter(h => h !== this.selectedGroupHash);
  }

  // åˆ‡æ¢ç»„å±•å¼€çŠ¶æ€
  private toggleGroup(hash: string) {
    const index = this.expandedGroups.indexOf(hash);
    if (index >= 0) {
      this.expandedGroups = this.expandedGroups.filter(h => h !== hash);
    } else {
      this.expandedGroups = this.expandedGroups.concat([hash]);
    }
  }

  // æ£€æŸ¥ç»„æ˜¯å¦å±•å¼€
  private isGroupExpanded(hash: string): boolean {
    return this.expandedGroups.indexOf(hash) >= 0;
  }

  // è·å–å˜æ›´çŠ¶æ€æ–‡å­—
  private getChangeStatusText(group: DuplicateGroup): string {
    if (!group.changeStatus) return '';

    switch (group.changeStatus) {
      case 'new':
        return `æ–°å¢é‡å¤ç»„ (+${group.changeCount})`;
      case 'increased':
        return `é‡å¤æ•°å¢åŠ  (+${group.changeCount})`;
      case 'decreased':
        return `é‡å¤æ•°å‡å°‘ (-${group.changeCount})`;
      default:
        return '';
    }
  }

  // è·å–å˜æ›´çŠ¶æ€é¢œè‰²
  private getChangeStatusColor(group: DuplicateGroup): string {
    switch (group.changeStatus) {
      case 'new':
        return '#FF9500';
      case 'increased':
        return '#FF3B30';
      case 'decreased':
        return '#34C759';
      default:
        return '#8E8E93';
    }
  }

  //æ–°å¢indexå‘½åæ–¹å¼ï¼ŒæŒ‰ç…§ç»„é‡å¤çš„å­—ç¬¦å‘½å
  private getGroupNameByHash(group: DuplicateGroup): string {
    // å–hashçš„å‰6-8ä¸ªå­—ç¬¦ï¼ˆé€šå¸¸è¶³å¤Ÿå”¯ä¸€æ ‡è¯†ï¼‰
    const hashPrefix = group.hash.substring(0, 8);
    console.log("å‘½ååç§°",hashPrefix)
    console.log("hashç±»å‹",typeof group.hash)
    return `é‡å¤ç»„ [${hashPrefix}]`;
  }

  private getSimpleHashName(group: DuplicateGroup,index:number): string {
    // ä»å¤åˆhashä¸­æå–å†…å®¹hashéƒ¨åˆ†
    const parts = group.hash.split('_');

    if (parts.length >= 2) {
      // parts[1] æ˜¯å†…å®¹çš„ç¬¬ä¸€ä¸ªhashå€¼
      const contentHash = parts[1];

      if (contentHash && contentHash.length >= 4) {
        // ä½¿ç”¨å†…å®¹hashçš„å‰4ä¸ªå­—ç¬¦
        return `[${contentHash.substring(0, 4).toUpperCase()}]`;
      }
    }
    // å›é€€æ–¹æ¡ˆï¼šä½¿ç”¨æ–‡ä»¶æ•°é‡
    return `${index+1}`;
  }


  build() {
    Column() {
      // === é¡¶éƒ¨æ ‡é¢˜å’Œæ‰«æä¿¡æ¯ ===
      Column() {
        Text('æ–‡ä»¶å»é‡')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .margin({ bottom: 8 })

        Row() {
          Text(`ä¸Šæ¬¡æ‰«æ: ${this.lastScanTime}`)
            .fontSize(12)
            .fontColor('#8E8E93')

          Blank()

          // æ‰«ææ¨¡å¼åˆ‡æ¢
          Row() {
            Text(this.useWorkerScan ? 'Workerå¤šçº¿ç¨‹' : 'ä¸»çº¿ç¨‹å¼‚æ­¥')
              .fontSize(11)
              .fontColor(this.useWorkerScan ? '#007AFF' : '#8E8E93')
              .margin({ right: 6 })

            Toggle({ type: ToggleType.Switch, isOn: this.useWorkerScan })
              .width(40)
              .height(22)
              .selectedColor('#007AFF')
              .onChange((isOn: boolean) => {
                this.useWorkerScan = isOn;
                this.scanModeText = isOn ? 'Workerå¤šçº¿ç¨‹' : 'ä¸»çº¿ç¨‹å¼‚æ­¥';
              })
          }
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })
      .alignItems(HorizontalAlign.Start)

      // === æ“ä½œæŒ‰é’®åŒº ===
      Row({ space: 10 }) {
        Button(this.isScanning ? 'æ‰«æä¸­...' : 'å…¨é‡æ‰«æ')
          .onClick(() => this.performFullScan())
          .enabled(!this.isScanning)
          .height(40)
          .fontSize(14)
          .backgroundColor(this.isScanning ? '#C7C7CC' : '#007AFF')
          .fontColor(Color.White)
          .borderRadius(8)
          .layoutWeight(1)

        Button('å¢é‡æ‰«æ')
          .onClick(() => this.performIncrementalScan())
          .enabled(!this.isScanning && this.lastScanTime !== 'ä»æœªæ‰«æ')
          .height(40)
          .fontSize(14)
          .backgroundColor((!this.isScanning && this.lastScanTime !== 'ä»æœªæ‰«æ') ? '#34C759' : '#C7C7CC')
          .fontColor(Color.White)
          .borderRadius(8)
          .layoutWeight(1)

        Button('ä¸€é”®å»é‡')
          .onClick(() => {
            if (this.scanResult && this.scanResult.duplicateGroups.length > 0) {
              this.confirmAction = 'dedup_all';
              this.showConfirmDialog = true;
            } else {
              this.showToast('è¯·å…ˆæ‰§è¡Œæ‰«æ', 'info');
            }
          })
          .enabled(!this.isScanning && this.scanResult !== null && this.scanResult.duplicateGroups.length > 0)
          .height(40)
          .fontSize(14)
          .backgroundColor(
            (!this.isScanning && this.scanResult !== null && this.scanResult.duplicateGroups.length > 0)
              ? '#FF3B30' : '#C7C7CC'
          )
          .fontColor(Color.White)
          .borderRadius(8)
          .layoutWeight(1)
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 12 })

      // === æ‰«æè¿›åº¦æ¡ ===
      if (this.isRealTimeScanning) {
        Column() {
          Row() {
            Text('æ‰«æè¿›åº¦')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .layoutWeight(1)

            Text(`${this.scanProgress}%`)
              .fontSize(14)
              .fontColor('#007AFF')
              .fontWeight(FontWeight.Bold)
          }
          .width('100%')
          .margin({ bottom: 8 })

          Progress({ value: this.scanProgress, total: 100, type: ProgressType.Linear })
            .color('#007AFF')
            .backgroundColor('#E0E0E0')
            .height(8)
            .width('100%')
            .borderRadius(4)

          if (this.scanProgressText) {
            Text(`å·²æ‰«ææ–‡ä»¶: ${this.scanProgressText}`)
              .fontSize(12)
              .fontColor('#8E8E93')
              .margin({ top: 6 })
          }
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 8, bottom: 12 })
        .backgroundColor('#F8F8F8')
        .borderRadius(12)
        .margin({ left: 16, right: 16, bottom: 12 })
      }

      // === æ¶ˆæ¯æç¤º ===
      if (this.showMessage) {
        Text(this.messageText)
          .fontSize(14)
          .fontColor('#FFFFFF')
          .backgroundColor(
            this.messageType === 'success' ? '#34C759' :
              (this.messageType === 'error' ? '#FF3B30' : '#007AFF')
          )
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .borderRadius(8)
          .margin({ left: 16, right: 16, bottom: 8 })
      }

      // === æ‰«æç»“æœç»Ÿè®¡ ===
      if (this.scanResult || this.isRealTimeScanning) {
        // æ ¹æ®æ‰«æçŠ¶æ€è·å–è¦æ˜¾ç¤ºçš„ç»Ÿè®¡æ•°æ®
        Row() {
          Column() {
            Text(`${this.isRealTimeScanning ? this.dynamicStats.scannedFiles : (this.scanResult?.scannedFiles || 0)}`)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#007AFF')
            Text(this.isRealTimeScanning ? 'å·²æ‰«æ' : 'æ‰«ææ–‡ä»¶')
              .fontSize(11)
              .fontColor('#8E8E93')
          }
          .layoutWeight(1)

          Column() {
            Text(`${this.isRealTimeScanning ? this.dynamicStats.duplicateGroups : (this.scanResult?.duplicateGroups.length || 0)}`)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FF9500')
            Text('é‡å¤ç»„')
              .fontSize(11)
              .fontColor('#8E8E93')
          }
          .layoutWeight(1)

          Column() {
            Text(`${this.isRealTimeScanning ? this.dynamicStats.totalDuplicates : (this.scanResult?.totalDuplicates || 0)}`)
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FF3B30')
            Text('é‡å¤æ–‡ä»¶')
              .fontSize(11)
              .fontColor('#8E8E93')
          }
          .layoutWeight(1)

          Column() {
            Text(this.isRealTimeScanning ? this.dynamicStats.totalWasteSizeReadable : (this.scanResult?.totalWasteSizeReadable || '0 B'))
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#34C759')
            Text('å¯èŠ‚çœ')
              .fontSize(11)
              .fontColor('#8E8E93')
          }
          .layoutWeight(1)
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 8, bottom: 12 })
        .backgroundColor(this.isRealTimeScanning ? '#FFF8E1' : '#F8F8F8')
        .borderRadius(12)
        .margin({ left: 16, right: 16, bottom: 12 })
      }

      // === é‡å¤æ–‡ä»¶åˆ—è¡¨ ===
      if (!this.scanResult && !this.isRealTimeScanning) {
        Column() {
          Text('ğŸ”')
            .fontSize(48)
            .margin({ bottom: 16 })
          Text('ç‚¹å‡»"å…¨é‡æ‰«æ"å¼€å§‹æ£€æµ‹é‡å¤æ–‡ä»¶')
            .fontSize(14)
            .fontColor('#8E8E93')
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else if (!this.isRealTimeScanning && this.scanResult && this.scanResult.duplicateGroups.length === 0) {
        Column() {
          Text('âœ…')
            .fontSize(48)
            .margin({ bottom: 16 })
          Text('å¤ªæ£’äº†ï¼æ²¡æœ‰å‘ç°é‡å¤æ–‡ä»¶')
            .fontSize(14)
            .fontColor('#8E8E93')
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else {
        // åŠ¨æ€æ’è¡Œæ¦œæç¤º
        if (this.isRealTimeScanning && this.dynamicGroups.length > 0) {
          Row() {
            Text(`ğŸ† åŠ¨æ€æ’è¡Œæ¦œ - æŒ‰å¯é‡Šæ”¾ç©ºé—´é™åºæ’åˆ—`)
              .fontSize(13)
              .fontWeight(FontWeight.Medium)
              .fontColor('#FF9500')
          }
          .width('100%')
          .padding({ left: 16, right: 16, bottom: 8 })
        }

        // å¢é‡æ‰«ææç¤º
        if (!this.isRealTimeScanning && this.scanResult && this.scanResult.isIncremental && this.scanResult.changedFiles > 0) {
          Row() {
            Text(`ğŸ“Š æœ¬æ¬¡ä»…æ‰«æå˜æ›´æ–‡ä»¶ï¼Œå…± ${this.scanResult.changedFiles} ä¸ªæ–‡ä»¶æœ‰å˜åŒ–`)
              .fontSize(12)
              .fontColor('#FF9500')
          }
          .width('100%')
          .padding({ left: 16, right: 16, bottom: 8 })
        }

        if (this.displayGroups.length === 0 && this.isRealTimeScanning) {
          // æ‰«æä¸­ä½†è¿˜æœªå‘ç°é‡å¤ç»„
          Column() {
            Text('ğŸ”„')
              .fontSize(48)
              .margin({ bottom: 16 })
            Text('æ­£åœ¨æ‰«ææ–‡ä»¶ï¼Œå¯»æ‰¾é‡å¤ç»„...')
              .fontSize(14)
              .fontColor('#8E8E93')
          }
          .width('100%')
          .height(200)
          .justifyContent(FlexAlign.Center)
        } else if (this.displayGroups.length > 0) {
          List({ space: 8 }) {
            ForEach(this.displayGroups, (group: DuplicateGroup, index: number) => {
            ListItem() {
              Column() {
                // ç»„æ ‡é¢˜è¡Œ
                Row() {
                  Column() {
                    Row() {
                      // Text(`é‡å¤ç»„ #${index + 1}`)
                      Text(`åŠ å¯†Hashå€¼${this.getSimpleHashName(group,index)}`)
                        .fontSize(16)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#333333')

                      if (group.changeStatus) {
                        Text(this.getChangeStatusText(group))
                          .fontSize(11)
                          .fontColor(Color.White)
                          .backgroundColor(this.getChangeStatusColor(group))
                          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                          .borderRadius(4)
                          .margin({ left: 8 })
                      }
                    }

                    Text(`${group.files.length} ä¸ªé‡å¤æ–‡ä»¶ Â· å¯èŠ‚çœ ${this.formatFileSize(group.wasteSize)}`)
                      .fontSize(12)
                      .fontColor('#8E8E93')
                      .margin({ top: 4 })
                  }
                  .alignItems(HorizontalAlign.Start)
                  .layoutWeight(1)

                  Text(this.isGroupExpanded(group.hash) ? 'â–¼' : 'â–¶')
                    .fontSize(14)
                    .fontColor('#8E8E93')
                }
                .width('100%')
                .padding(12)
                .onClick(() => this.toggleGroup(group.hash))

                // å±•å¼€çš„æ–‡ä»¶åˆ—è¡¨
                if (this.isGroupExpanded(group.hash)) {
                  Column({ space: 6 }) {
                    ForEach(group.files, (file: DuplicateFileInfo, fileIndex: number) => {
                      Row() {
                        Column() {
                          Row() {
                            if (fileIndex === 0) {
                              Text('ä¿ç•™')
                                .fontSize(10)
                                .fontColor(Color.White)
                                .backgroundColor('#34C759')
                                .padding({ left: 4, right: 4, top: 1, bottom: 1 })
                                .borderRadius(4)
                                .margin({ right: 6 })
                            }

                            if (file.isNew) {
                              Text('æ–°å¢')
                                .fontSize(10)
                                .fontColor(Color.White)
                                .backgroundColor('#FF9500')
                                .padding({ left: 4, right: 4, top: 1, bottom: 1 })
                                .borderRadius(4)
                                .margin({ right: 6 })
                            }

                            Text(file.filename)
                              .fontSize(14)
                              .fontColor('#333333')
                              .maxLines(1)
                              .textOverflow({ overflow: TextOverflow.Ellipsis })
                          }

                          Text(`${file.sizeReadable} Â· ${file.mtimeFormatted}`)
                            .fontSize(11)
                            .fontColor('#8E8E93')
                            .margin({ top: 2 })
                        }
                        .alignItems(HorizontalAlign.Start)
                        .layoutWeight(1)

                        Row({ space: 4 }) {
                          Button('æŸ¥çœ‹')
                            .onClick(() => {
                              this.viewFileContent(file.filename);
                            })
                            .height(28)
                            .fontSize(11)
                            .backgroundColor('#8E8E93')
                            .fontColor(Color.White)
                            .borderRadius(14)

                          if (fileIndex !== 0) {
                            Button('ä¿ç•™æ­¤æ–‡ä»¶')
                              .onClick(() => {
                                this.selectedGroupHash = group.hash;
                                this.selectedKeepFile = file.filename;
                                this.confirmAction = 'dedup_group';
                                this.showConfirmDialog = true;
                              })
                              .height(28)
                              .fontSize(11)
                              .backgroundColor('#007AFF')
                              .fontColor(Color.White)
                              .borderRadius(14)
                          }
                        }
                      }
                      .width('100%')
                      .padding({ left: 12, right: 12, top: 8, bottom: 8 })
                      .backgroundColor(fileIndex === 0 ? '#E8F5E9' : '#FFF8E1')
                      .borderRadius(8)
                    })

                    // å¿«é€Ÿæ“ä½œæŒ‰é’®
                    Row({ space: 10 }) {
                      Button('ä¿ç•™ç¬¬ä¸€ä¸ªï¼Œåˆ é™¤å…¶ä»–')
                        .onClick(() => {
                          this.selectedGroupHash = group.hash;
                          this.selectedKeepFile = group.files[0].filename;
                          this.confirmAction = 'dedup_group';
                          this.showConfirmDialog = true;
                        })
                        .height(36)
                        .fontSize(13)
                        .backgroundColor('#FF3B30')
                        .fontColor(Color.White)
                        .borderRadius(8)
                        .layoutWeight(1)
                    }
                    .width('100%')
                    .padding({ top: 8 })
                  }
                  .width('100%')
                  .padding({ left: 12, right: 12, bottom: 12 })
                }
              }
              .backgroundColor(Color.White)
              .borderRadius(12)
              .border({ width: 1, color: '#E0E0E0' })
              .transition({
                type: TransitionType.Insert,
                opacity: 0,
                translate: { x: 0, y: 50 }
              })
              .transition({
                type: TransitionType.Delete,
                opacity: 0,
                translate: { x: 0, y: -50 }
              })
            }
          })
        }
        .width('100%')
        .layoutWeight(1)
        .padding({ left: 16, right: 16 })
        }
      }

      // === ç¡®è®¤å¯¹è¯æ¡† ===
      if (this.showConfirmDialog) {
        Stack()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.5)')
          .onClick(() => {
            this.showConfirmDialog = false;
          })
          .position({ x: 0, y: 0 })

        Column() {
          Text(this.confirmAction === 'dedup_all' ? 'ç¡®è®¤ä¸€é”®å»é‡' : 'ç¡®è®¤åˆ é™¤é‡å¤æ–‡ä»¶')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .margin({ bottom: 16 })

          Text(
            this.confirmAction === 'dedup_all'
              ? `å³å°†åˆ é™¤æ‰€æœ‰é‡å¤ç»„ä¸­çš„å¤šä½™æ–‡ä»¶ï¼Œæ¯ç»„ä¿ç•™æœ€æ—©åˆ›å»ºçš„æ–‡ä»¶ã€‚\n\nå…± ${this.scanResult ? this.scanResult.duplicateGroups.length : 0} ç»„é‡å¤æ–‡ä»¶å°†è¢«å¤„ç†ã€‚\n\nåˆ é™¤çš„æ–‡ä»¶å°†ç§»å…¥å›æ”¶ç«™ï¼Œå¯ä»¥æ¢å¤ã€‚`
              : `å³å°†åˆ é™¤è¯¥ç»„ä¸­é™¤ "${this.selectedKeepFile}" ä»¥å¤–çš„æ‰€æœ‰æ–‡ä»¶ã€‚\n\nåˆ é™¤çš„æ–‡ä»¶å°†ç§»å…¥å›æ”¶ç«™ï¼Œå¯ä»¥æ¢å¤ã€‚`
          )
            .fontSize(14)
            .fontColor('#666666')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 24 })

          Row({ space: 16 }) {
            Button('å–æ¶ˆ')
              .onClick(() => {
                this.showConfirmDialog = false;
              })
              .height(44)
              .fontSize(16)
              .backgroundColor('#E0E0E0')
              .fontColor('#333333')
              .borderRadius(8)
              .layoutWeight(1)

            Button('ç¡®è®¤åˆ é™¤')
              .onClick(() => {
                if (this.confirmAction === 'dedup_all') {
                  this.performDeduplicateAll();
                } else {
                  this.performDeduplicateGroup();
                }
              })
              .height(44)
              .fontSize(16)
              .backgroundColor('#FF3B30')
              .fontColor(Color.White)
              .borderRadius(8)
              .layoutWeight(1)
          }
          .width('100%')
        }
        .width('85%')
        .padding(24)
        .backgroundColor(Color.White)
        .borderRadius(16)
        .position({ x: '7.5%', y: '30%' })
      }

      // === æ–‡ä»¶å†…å®¹æŸ¥çœ‹å¯¹è¯æ¡† ===
      if (this.showFileContentDialog) {
        Stack()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.5)')
          .onClick(() => {
            this.showFileContentDialog = false;
          })
          .position({ x: 0, y: 0 })

        Column() {
          // æ ‡é¢˜æ 
          Row() {
            Text('æ–‡ä»¶å†…å®¹')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .layoutWeight(1)

            Button('Ã—')
              .fontSize(24)
              .fontColor('#666666')
              .backgroundColor(Color.Transparent)
              .onClick(() => {
                this.showFileContentDialog = false;
              })
          }
          .width('100%')
          .padding({ left: 20, right: 20, top: 15, bottom: 15 })
          .border({ width: { bottom: 1 }, color: '#E0E0E0' })

          // æ–‡ä»¶å
          Row() {
            Text('æ–‡ä»¶å:')
              .fontSize(14)
              .fontColor('#666666')
              .width('20%')
            Text(this.viewingFileName)
              .fontSize(14)
              .fontColor('#007AFF')
              .fontWeight(FontWeight.Medium)
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .width('80%')
          }
          .width('100%')
          .padding({ left: 20, right: 20, top: 12 })

          // æ–‡ä»¶å†…å®¹
          Scroll() {
            Text(this.viewingFileContent)
              .fontSize(13)
              .fontColor('#333333')
              .fontFamily('monospace')
              .width('100%')
          }
          .width('100%')
          .height(300)
          .padding(16)
          .margin({ left: 20, right: 20, top: 12, bottom: 12 })
          .backgroundColor('#F8F8F8')
          .borderRadius(8)

          // å…³é—­æŒ‰é’®
          Button('å…³é—­')
            .onClick(() => {
              this.showFileContentDialog = false;
            })
            .width('90%')
            .height(44)
            .fontSize(16)
            .backgroundColor('#007AFF')
            .fontColor(Color.White)
            .borderRadius(10)
            .margin({ bottom: 20 })
        }
        .width('90%')
        .backgroundColor(Color.White)
        .borderRadius(16)
        .position({ x: '5%', y: '10%' })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
  private formatFileSize(bytes: number): string {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))} ${sizes[i]}`;
  }
}
